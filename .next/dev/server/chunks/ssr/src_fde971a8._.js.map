{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/config/constants.ts"],"sourcesContent":["const env =\n    (typeof import.meta !== 'undefined' && (import.meta as any).env)\n        ? (import.meta as any).env\n        : (process.env as any);\n\nexport const MODEL = {\n    FLASH: 'gemini-3-flash-preview',\n    IMAGE_PREVIEW: 'google/gemini-2.5-flash-image',\n};\n\nexport const EMBED_MODEL_ID =\n    env?.VITE_EMBED_MODEL_ID ||\n    env?.VITE_AI_EMBED_MODEL_ID ||\n    env?.AI_EMBED_MODEL_ID ||\n    'gemini-embedding-001';\n\nexport const PRICING = {\n    FLASH: {\n        input: 0.30 / 1000000,\n        output: 0.30 / 1000000,\n    },\n    IMAGE_PREVIEW: {\n        input: 0.30 / 1000000,\n        output: 30.00 / 1000000,\n    },\n    IMAGE_GEN: {\n        input: 0.30 / 1000000,\n        output: 30.00 / 1000000,\n    },\n};\n\nexport const AI_DEFAULTS = {\n    RETRY_ATTEMPTS: 2,\n    RETRY_DELAY_MS: 300,\n    // Longer timeout to accommodate heavy multimodal/long-context calls\n    TIMEOUT_MS: 120000,\n};\n\n// Magic number tuned to balance keyword coverage with AI speed/cost\nexport const SEMANTIC_KEYWORD_LIMIT = 30;\nexport const KEYWORD_CHAR_DIVISOR = 200;\nexport const MIN_KEYWORDS = 10;\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;AAAA,MAAM,MACF,AAAC,+CAAuB,eAAe,8BAAqB,GAAG,GACzD,8BAAqB,GAAG,GACvB,QAAQ,GAAG;AAEf,MAAM,QAAQ;IACjB,OAAO;IACP,eAAe;AACnB;AAEO,MAAM,iBACT,KAAK,uBACL,KAAK,0BACL,KAAK,qBACL;AAEG,MAAM,UAAU;IACnB,OAAO;QACH,OAAO,OAAO;QACd,QAAQ,OAAO;IACnB;IACA,eAAe;QACX,OAAO,OAAO;QACd,QAAQ,QAAQ;IACpB;IACA,WAAW;QACP,OAAO,OAAO;QACd,QAAQ,QAAQ;IACpB;AACJ;AAEO,MAAM,cAAc;IACvB,gBAAgB;IAChB,gBAAgB;IAChB,oEAAoE;IACpE,YAAY;AAChB;AAGO,MAAM,yBAAyB;AAC/B,MAAM,uBAAuB;AAC7B,MAAM,eAAe"}},
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/store/useAppStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { persist, createJSONStorage } from 'zustand/middleware';\nimport { ContentScore, SavedProfile, ScrapedImage } from '@/types';\nimport { MODEL, KEYWORD_CHAR_DIVISOR, MIN_KEYWORDS, SEMANTIC_KEYWORD_LIMIT } from '@/config/constants';\n\ninterface AppState {\n    // UI Slice\n    showInput: boolean;\n    showSidebar: boolean;\n    showChangelog: boolean;\n    showPlanModal: boolean;\n    showSettings: boolean;\n    inputType: 'text' | 'url';\n    displayScale: number;\n\n    // Metrics Slice\n    contentScore: ContentScore;\n    sessionCost: number;\n    sessionTokens: number;\n\n    // Settings Slice\n    modelFlash: string;\n    modelImage: string;\n    keywordCharDivisor: number;\n    minKeywords: number;\n    maxKeywords: number;\n\n    // Profile Slice\n    savedProfiles: SavedProfile[];\n    activeProfile: SavedProfile | null;\n\n    // Actions\n    toggleInput: () => void;\n    toggleSidebar: () => void;\n    setShowSidebar: (show: boolean) => void;\n    setShowChangelog: (show: boolean) => void;\n    setShowPlanModal: (show: boolean) => void;\n    setShowSettings: (show: boolean) => void;\n    setInputType: (type: 'text' | 'url') => void;\n    setDisplayScale: (scale: number) => void;\n\n    setContentScore: (score: ContentScore) => void;\n    addCost: (cost: number, tokens: number) => void;\n    resetSessionStats: () => void;\n\n    setModelFlash: (model: string) => void;\n    setModelImage: (model: string) => void;\n    setKeywordCharDivisor: (divisor: number) => void;\n    setMinKeywords: (min: number) => void;\n    setMaxKeywords: (max: number) => void;\n    resetSettings: () => void;\n\n    setSavedProfiles: (profiles: SavedProfile[]) => void;\n    setActiveProfile: (profile: SavedProfile | null) => void;\n    addProfile: (profile: SavedProfile) => void;\n    updateProfile: (profile: SavedProfile) => void;\n    deleteProfile: (id: string) => void;\n}\n\nexport const useAppStore = create<AppState>()(\n    persist(\n        (set) => ({\n            // Defaults\n            showInput: true,\n            showSidebar: true,\n            showChangelog: false,\n            showPlanModal: false,\n            showSettings: false,\n            inputType: 'url',\n            displayScale: 1.1,\n\n            contentScore: { value: 0, label: 'Start Writing', color: 'text-gray-400' },\n            sessionCost: 0,\n            sessionTokens: 0,\n\n            modelFlash: MODEL.FLASH,\n            modelImage: MODEL.IMAGE_PREVIEW,\n            keywordCharDivisor: KEYWORD_CHAR_DIVISOR,\n            minKeywords: MIN_KEYWORDS,\n            maxKeywords: SEMANTIC_KEYWORD_LIMIT,\n\n            savedProfiles: [],\n            activeProfile: null,\n\n            // Actions\n            toggleInput: () => set((state) => ({ showInput: !state.showInput })),\n            toggleSidebar: () => set((state) => ({ showSidebar: !state.showSidebar })),\n            setShowSidebar: (show) => set({ showSidebar: show }),\n            setShowChangelog: (show) => set({ showChangelog: show }),\n            setShowPlanModal: (show) => set({ showPlanModal: show }),\n            setShowSettings: (show) => set({ showSettings: show }),\n            setInputType: (type) => set({ inputType: type }),\n            setDisplayScale: (scale) => set({ displayScale: scale }),\n\n            setContentScore: (score) => set({ contentScore: score }),\n            addCost: (cost, tokens) => set((state) => ({\n                sessionCost: Number(state.sessionCost || 0) + Number(cost || 0),\n                sessionTokens: Number(state.sessionTokens || 0) + Number(tokens || 0)\n            })),\n            resetSessionStats: () => set({ sessionCost: 0, sessionTokens: 0 }),\n\n            setModelFlash: (model) => set({ modelFlash: model }),\n            setModelImage: (model) => set({ modelImage: model }),\n            setKeywordCharDivisor: (divisor) => set({ keywordCharDivisor: divisor }),\n            setMinKeywords: (min) => set({ minKeywords: min }),\n            setMaxKeywords: (max) => set({ maxKeywords: max }),\n            resetSettings: () => set({\n                modelFlash: MODEL.FLASH,\n                modelImage: MODEL.IMAGE_PREVIEW,\n                keywordCharDivisor: KEYWORD_CHAR_DIVISOR,\n                minKeywords: MIN_KEYWORDS,\n                maxKeywords: SEMANTIC_KEYWORD_LIMIT,\n            }),\n\n            setSavedProfiles: (profiles) => set({ savedProfiles: profiles }),\n            setActiveProfile: (profile) => set({ activeProfile: profile }),\n            addProfile: (profile) => set((state) => ({\n                savedProfiles: [...state.savedProfiles, profile],\n                activeProfile: profile\n            })),\n            updateProfile: (updatedProfile) => set((state) => ({\n                savedProfiles: state.savedProfiles.map((p) =>\n                    p.id === updatedProfile.id ? updatedProfile : p\n                ),\n                activeProfile: state.activeProfile?.id === updatedProfile.id ? updatedProfile : state.activeProfile\n            })),\n            deleteProfile: (id) => set((state) => ({\n                savedProfiles: state.savedProfiles.filter((p) => p.id !== id),\n                activeProfile: state.activeProfile?.id === id ? null : state.activeProfile\n            })),\n        }),\n        {\n            name: 'pro_content_writer_app_v1',\n            storage: createJSONStorage(() => localStorage),\n        }\n    )\n);\n"],"names":[],"mappings":";;;;AAAA;AACA;AAEA;;;;AAwDO,MAAM,cAAc,IAAA,kJAAM,IAC7B,IAAA,wJAAO,EACH,CAAC,MAAQ,CAAC;QACN,WAAW;QACX,WAAW;QACX,aAAa;QACb,eAAe;QACf,eAAe;QACf,cAAc;QACd,WAAW;QACX,cAAc;QAEd,cAAc;YAAE,OAAO;YAAG,OAAO;YAAiB,OAAO;QAAgB;QACzE,aAAa;QACb,eAAe;QAEf,YAAY,mIAAK,CAAC,KAAK;QACvB,YAAY,mIAAK,CAAC,aAAa;QAC/B,oBAAoB,kJAAoB;QACxC,aAAa,0IAAY;QACzB,aAAa,oJAAsB;QAEnC,eAAe,EAAE;QACjB,eAAe;QAEf,UAAU;QACV,aAAa,IAAM,IAAI,CAAC,QAAU,CAAC;oBAAE,WAAW,CAAC,MAAM,SAAS;gBAAC,CAAC;QAClE,eAAe,IAAM,IAAI,CAAC,QAAU,CAAC;oBAAE,aAAa,CAAC,MAAM,WAAW;gBAAC,CAAC;QACxE,gBAAgB,CAAC,OAAS,IAAI;gBAAE,aAAa;YAAK;QAClD,kBAAkB,CAAC,OAAS,IAAI;gBAAE,eAAe;YAAK;QACtD,kBAAkB,CAAC,OAAS,IAAI;gBAAE,eAAe;YAAK;QACtD,iBAAiB,CAAC,OAAS,IAAI;gBAAE,cAAc;YAAK;QACpD,cAAc,CAAC,OAAS,IAAI;gBAAE,WAAW;YAAK;QAC9C,iBAAiB,CAAC,QAAU,IAAI;gBAAE,cAAc;YAAM;QAEtD,iBAAiB,CAAC,QAAU,IAAI;gBAAE,cAAc;YAAM;QACtD,SAAS,CAAC,MAAM,SAAW,IAAI,CAAC,QAAU,CAAC;oBACvC,aAAa,OAAO,MAAM,WAAW,IAAI,KAAK,OAAO,QAAQ;oBAC7D,eAAe,OAAO,MAAM,aAAa,IAAI,KAAK,OAAO,UAAU;gBACvE,CAAC;QACD,mBAAmB,IAAM,IAAI;gBAAE,aAAa;gBAAG,eAAe;YAAE;QAEhE,eAAe,CAAC,QAAU,IAAI;gBAAE,YAAY;YAAM;QAClD,eAAe,CAAC,QAAU,IAAI;gBAAE,YAAY;YAAM;QAClD,uBAAuB,CAAC,UAAY,IAAI;gBAAE,oBAAoB;YAAQ;QACtE,gBAAgB,CAAC,MAAQ,IAAI;gBAAE,aAAa;YAAI;QAChD,gBAAgB,CAAC,MAAQ,IAAI;gBAAE,aAAa;YAAI;QAChD,eAAe,IAAM,IAAI;gBACrB,YAAY,mIAAK,CAAC,KAAK;gBACvB,YAAY,mIAAK,CAAC,aAAa;gBAC/B,oBAAoB,kJAAoB;gBACxC,aAAa,0IAAY;gBACzB,aAAa,oJAAsB;YACvC;QAEA,kBAAkB,CAAC,WAAa,IAAI;gBAAE,eAAe;YAAS;QAC9D,kBAAkB,CAAC,UAAY,IAAI;gBAAE,eAAe;YAAQ;QAC5D,YAAY,CAAC,UAAY,IAAI,CAAC,QAAU,CAAC;oBACrC,eAAe;2BAAI,MAAM,aAAa;wBAAE;qBAAQ;oBAChD,eAAe;gBACnB,CAAC;QACD,eAAe,CAAC,iBAAmB,IAAI,CAAC,QAAU,CAAC;oBAC/C,eAAe,MAAM,aAAa,CAAC,GAAG,CAAC,CAAC,IACpC,EAAE,EAAE,KAAK,eAAe,EAAE,GAAG,iBAAiB;oBAElD,eAAe,MAAM,aAAa,EAAE,OAAO,eAAe,EAAE,GAAG,iBAAiB,MAAM,aAAa;gBACvG,CAAC;QACD,eAAe,CAAC,KAAO,IAAI,CAAC,QAAU,CAAC;oBACnC,eAAe,MAAM,aAAa,CAAC,MAAM,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK;oBAC1D,eAAe,MAAM,aAAa,EAAE,OAAO,KAAK,OAAO,MAAM,aAAa;gBAC9E,CAAC;IACL,CAAC,GACD;IACI,MAAM;IACN,SAAS,IAAA,kKAAiB,EAAC,IAAM;AACrC"}},
    {"offset": {"line": 178, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/store/useGenerationStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { persist, createJSONStorage } from 'zustand/middleware';\nimport { ArticleConfig, GenerationStatus, GenerationStep } from '../types';\n\ninterface GenerationState {\n    content: string;\n    status: GenerationStatus;\n    generationStep: GenerationStep;\n    error: string | null;\n    isStopped: boolean;\n    analysisResults: { productResult: any; structureResult: any } | null;\n    lastConfig: ArticleConfig | null;\n    setContent: (content: string | ((prev: string) => string)) => void;\n    setStatus: (status: GenerationStatus) => void;\n    setGenerationStep: (step: GenerationStep) => void;\n    setError: (error: string | null) => void;\n    setAnalysisResults: (results: { productResult: any; structureResult: any } | null) => void;\n    setLastConfig: (config: ArticleConfig | null) => void;\n    stopGeneration: () => void;\n    resetGeneration: () => void;\n}\n\nexport const useGenerationStore = create<GenerationState>()(\n    persist(\n        (set) => ({\n            content: '',\n            status: 'idle',\n            generationStep: 'idle',\n            error: null,\n            isStopped: false,\n            analysisResults: null,\n            lastConfig: null,\n            setContent: (content) => set((state) => ({\n                content: typeof content === 'function' ? content(state.content) : content\n            })),\n            setStatus: (status) => set({ status }),\n            setGenerationStep: (step) => set({ generationStep: step }),\n            setError: (error) => set({ error }),\n            setAnalysisResults: (results) => set({ analysisResults: results }),\n            setLastConfig: (config) => set({ lastConfig: config }),\n            stopGeneration: () => set({ isStopped: true, status: 'completed', generationStep: 'idle' }),\n            resetGeneration: () => set({\n                content: '',\n                status: 'idle',\n                generationStep: 'idle',\n                error: null,\n                isStopped: false,\n                analysisResults: null,\n                lastConfig: null\n            }),\n        }),\n        {\n            name: 'pro_content_writer_generation',\n            storage: createJSONStorage(() => localStorage),\n            partialize: (state) => ({\n                content: state.content,\n            }),\n        }\n    )\n);\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAqBO,MAAM,qBAAqB,IAAA,kJAAM,IACpC,IAAA,wJAAO,EACH,CAAC,MAAQ,CAAC;QACN,SAAS;QACT,QAAQ;QACR,gBAAgB;QAChB,OAAO;QACP,WAAW;QACX,iBAAiB;QACjB,YAAY;QACZ,YAAY,CAAC,UAAY,IAAI,CAAC,QAAU,CAAC;oBACrC,SAAS,OAAO,YAAY,aAAa,QAAQ,MAAM,OAAO,IAAI;gBACtE,CAAC;QACD,WAAW,CAAC,SAAW,IAAI;gBAAE;YAAO;QACpC,mBAAmB,CAAC,OAAS,IAAI;gBAAE,gBAAgB;YAAK;QACxD,UAAU,CAAC,QAAU,IAAI;gBAAE;YAAM;QACjC,oBAAoB,CAAC,UAAY,IAAI;gBAAE,iBAAiB;YAAQ;QAChE,eAAe,CAAC,SAAW,IAAI;gBAAE,YAAY;YAAO;QACpD,gBAAgB,IAAM,IAAI;gBAAE,WAAW;gBAAM,QAAQ;gBAAa,gBAAgB;YAAO;QACzF,iBAAiB,IAAM,IAAI;gBACvB,SAAS;gBACT,QAAQ;gBACR,gBAAgB;gBAChB,OAAO;gBACP,WAAW;gBACX,iBAAiB;gBACjB,YAAY;YAChB;IACJ,CAAC,GACD;IACI,MAAM;IACN,SAAS,IAAA,kKAAiB,EAAC,IAAM;IACjC,YAAY,CAAC,QAAU,CAAC;YACpB,SAAS,MAAM,OAAO;QAC1B,CAAC;AACL"}},
    {"offset": {"line": 237, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/store/useAnalysisStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { persist, createJSONStorage } from 'zustand/middleware';\nimport {\n    AuthorityAnalysis,\n    FrequentWordsPlacementAnalysis,\n    ProblemProductMapping,\n    ProductBrief,\n    ReferenceAnalysis,\n    ScrapedImage,\n    TargetAudience\n} from '../types';\n\ninterface AnalysisState {\n    keywordPlans: FrequentWordsPlacementAnalysis[];\n    refAnalysis: ReferenceAnalysis | null;\n    authAnalysis: AuthorityAnalysis | null;\n    scrapedImages: ScrapedImage[];\n    visualStyle: string;\n    brandKnowledge: string;\n    coveredPoints: string[];\n    targetAudience: TargetAudience;\n    productMapping: ProblemProductMapping[];\n    activeProductBrief: ProductBrief | undefined;\n    articleTitle: string;\n    headingOptimizations: {\n        h2_before: string;\n        h2_after: string;\n        h2_reason?: string;\n        h2_options?: { text: string; reason?: string; score?: number }[];\n        needs_manual?: boolean;\n        h3?: { h3_before: string; h3_after: string; h3_reason?: string }[];\n    }[];\n    languageInstruction: string;\n    hkGroundingResult: {\n        isHKRelevant: boolean;\n        relevanceScore: number;\n        issues: { type: string; original: string; hkEquivalent: string; confidence: number; context: string }[];\n        suggestions: { original: string; rewritten: string }[];\n    } | null;\n    // NEW: Pending grounding for confirmation modal\n    pendingGroundingResult: {\n        issues: { type: string; original: string; regionEquivalent: string; confidence: number; context: string; selected: boolean }[];\n        rewrittenContent: string;\n        regionLabel: string;\n    } | null;\n    showGroundingModal: boolean;\n    // NEW: Localized plan stored separately\n    localizedRefAnalysis: ReferenceAnalysis | null;\n    setKeywordPlans: (plans: FrequentWordsPlacementAnalysis[]) => void;\n    setRefAnalysis: (analysis: ReferenceAnalysis | null) => void;\n    setAuthAnalysis: (analysis: AuthorityAnalysis | null) => void;\n    setScrapedImages: (images: ScrapedImage[]) => void;\n    setVisualStyle: (style: string) => void;\n    setBrandKnowledge: (knowledge: string) => void;\n    setCoveredPoints: (points: string[] | ((prev: string[]) => string[])) => void;\n    setTargetAudience: (audience: TargetAudience) => void;\n    setProductMapping: (mapping: ProblemProductMapping[]) => void;\n    setActiveProductBrief: (brief: ProductBrief | undefined) => void;\n    setArticleTitle: (title: string) => void;\n    setHeadingOptimizations: (items: {\n        h2_before: string;\n        h2_after: string;\n        h2_reason?: string;\n        h2_options?: { text: string; reason?: string; score?: number }[];\n        needs_manual?: boolean;\n        h3?: { h3_before: string; h3_after: string; h3_reason?: string }[];\n    }[]) => void;\n    setLanguageInstruction: (instruction: string) => void;\n    setHKGroundingResult: (result: AnalysisState['hkGroundingResult']) => void;\n    // NEW: Pending grounding actions\n    setPendingGroundingResult: (result: AnalysisState['pendingGroundingResult']) => void;\n    setShowGroundingModal: (show: boolean) => void;\n    toggleGroundingIssueSelection: (index: number) => void;\n    setLocalizedRefAnalysis: (analysis: ReferenceAnalysis | null) => void;\n    reset: () => void;\n}\n\nexport const useAnalysisStore = create<AnalysisState>()(\n    persist(\n        (set) => ({\n            keywordPlans: [],\n            refAnalysis: null,\n            authAnalysis: null,\n            scrapedImages: [],\n            visualStyle: '',\n            brandKnowledge: '',\n            coveredPoints: [],\n            targetAudience: 'zh-TW',\n            productMapping: [],\n            activeProductBrief: undefined,\n            articleTitle: '',\n            headingOptimizations: [],\n            languageInstruction: '',\n            hkGroundingResult: null,\n            pendingGroundingResult: null,\n            showGroundingModal: false,\n            localizedRefAnalysis: null,\n            setKeywordPlans: (plans) => set({ keywordPlans: plans }),\n            setRefAnalysis: (analysis) => set({ refAnalysis: analysis }),\n            setAuthAnalysis: (analysis) => set({ authAnalysis: analysis }),\n            setScrapedImages: (images) => set({ scrapedImages: images }),\n            setVisualStyle: (style) => set({ visualStyle: style }),\n            setBrandKnowledge: (knowledge) => set({ brandKnowledge: knowledge }),\n            setCoveredPoints: (points) => set((state) => ({\n                coveredPoints: typeof points === 'function' ? points(state.coveredPoints) : points\n            })),\n            setTargetAudience: (audience) => set({ targetAudience: audience }),\n            setProductMapping: (mapping) => set({ productMapping: mapping }),\n            setActiveProductBrief: (brief) => set({ activeProductBrief: brief }),\n            setArticleTitle: (title) => set({ articleTitle: title }),\n            setHeadingOptimizations: (items) => set({ headingOptimizations: items }),\n            setLanguageInstruction: (instruction) => set({ languageInstruction: instruction }),\n            setHKGroundingResult: (result) => set({ hkGroundingResult: result }),\n            setPendingGroundingResult: (result) => set({ pendingGroundingResult: result }),\n            setShowGroundingModal: (show) => set({ showGroundingModal: show }),\n            toggleGroundingIssueSelection: (index) => set((state) => {\n                if (!state.pendingGroundingResult) return state;\n                const newIssues = state.pendingGroundingResult.issues.map((issue, i) =>\n                    i === index ? { ...issue, selected: !issue.selected } : issue\n                );\n                return {\n                    pendingGroundingResult: {\n                        ...state.pendingGroundingResult,\n                        issues: newIssues\n                    }\n                };\n            }),\n            setLocalizedRefAnalysis: (analysis) => set({ localizedRefAnalysis: analysis }),\n            reset: () => set({\n                keywordPlans: [],\n                refAnalysis: null,\n                authAnalysis: null,\n                scrapedImages: [],\n                visualStyle: '',\n                brandKnowledge: '',\n                coveredPoints: [],\n                targetAudience: 'zh-TW',\n                productMapping: [],\n                activeProductBrief: undefined,\n                articleTitle: '',\n                headingOptimizations: [],\n                languageInstruction: '',\n                hkGroundingResult: null,\n                pendingGroundingResult: null,\n                showGroundingModal: false,\n                localizedRefAnalysis: null,\n            }),\n        }),\n        {\n            name: 'pro_content_writer_analysis',\n            storage: createJSONStorage(() => localStorage),\n            partialize: (state) => ({\n                keywordPlans: state.keywordPlans,\n                refAnalysis: state.refAnalysis,\n                authAnalysis: state.authAnalysis,\n                scrapedImages: state.scrapedImages,\n                visualStyle: state.visualStyle,\n                brandKnowledge: state.brandKnowledge,\n                coveredPoints: state.coveredPoints,\n                targetAudience: state.targetAudience,\n                articleTitle: state.articleTitle,\n                headingOptimizations: state.headingOptimizations,\n                languageInstruction: state.languageInstruction,\n                productMapping: state.productMapping,\n                activeProductBrief: state.activeProductBrief,\n                localizedRefAnalysis: state.localizedRefAnalysis,\n            }),\n        }\n    )\n);\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 370, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/store/useMetricsStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { persist, createJSONStorage } from 'zustand/middleware';\nimport { ContentScore } from '../types';\n\ninterface MetricsState {\n    contentScore: ContentScore;\n    sessionCost: number;\n    sessionTokens: number;\n    setContentScore: (score: ContentScore) => void;\n    addCost: (cost: number, tokens: number) => void;\n    resetSessionStats: () => void;\n}\n\nexport const useMetricsStore = create<MetricsState>()(\n    persist(\n        (set) => ({\n            contentScore: { value: 0, label: 'Start Writing', color: 'text-gray-400' },\n            sessionCost: 0,\n            sessionTokens: 0,\n            setContentScore: (score) => set({ contentScore: score }),\n            addCost: (cost, tokens) => set((state) => ({\n                sessionCost: Number(state.sessionCost || 0) + Number(cost || 0),\n                sessionTokens: Number(state.sessionTokens || 0) + Number(tokens || 0)\n            })),\n            resetSessionStats: () => set({ sessionCost: 0, sessionTokens: 0 }),\n        }),\n        {\n            name: 'pro_content_writer_metrics',\n            storage: createJSONStorage(() => localStorage),\n            merge: (persisted, current) => {\n                const typed = persisted as Partial<MetricsState> | undefined;\n                return {\n                    ...current,\n                    ...typed,\n                    sessionCost: Number(typed?.sessionCost ?? current.sessionCost ?? 0),\n                    sessionTokens: Number(typed?.sessionTokens ?? current.sessionTokens ?? 0),\n                };\n            },\n            partialize: (state) => ({\n                sessionCost: state.sessionCost,\n                sessionTokens: state.sessionTokens,\n            }),\n        }\n    )\n);\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAYO,MAAM,kBAAkB,IAAA,kJAAM,IACjC,IAAA,wJAAO,EACH,CAAC,MAAQ,CAAC;QACN,cAAc;YAAE,OAAO;YAAG,OAAO;YAAiB,OAAO;QAAgB;QACzE,aAAa;QACb,eAAe;QACf,iBAAiB,CAAC,QAAU,IAAI;gBAAE,cAAc;YAAM;QACtD,SAAS,CAAC,MAAM,SAAW,IAAI,CAAC,QAAU,CAAC;oBACvC,aAAa,OAAO,MAAM,WAAW,IAAI,KAAK,OAAO,QAAQ;oBAC7D,eAAe,OAAO,MAAM,aAAa,IAAI,KAAK,OAAO,UAAU;gBACvE,CAAC;QACD,mBAAmB,IAAM,IAAI;gBAAE,aAAa;gBAAG,eAAe;YAAE;IACpE,CAAC,GACD;IACI,MAAM;IACN,SAAS,IAAA,kKAAiB,EAAC,IAAM;IACjC,OAAO,CAAC,WAAW;QACf,MAAM,QAAQ;QACd,OAAO;YACH,GAAG,OAAO;YACV,GAAG,KAAK;YACR,aAAa,OAAO,OAAO,eAAe,QAAQ,WAAW,IAAI;YACjE,eAAe,OAAO,OAAO,iBAAiB,QAAQ,aAAa,IAAI;QAC3E;IACJ;IACA,YAAY,CAAC,QAAU,CAAC;YACpB,aAAa,MAAM,WAAW;YAC9B,eAAe,MAAM,aAAa;QACtC,CAAC;AACL"}},
    {"offset": {"line": 418, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/store/useUiStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { persist, createJSONStorage } from 'zustand/middleware';\n\ninterface UiState {\n    showInput: boolean;\n    showSidebar: boolean;\n    showChangelog: boolean;\n    showPlanModal: boolean;\n    showSettings: boolean;\n    inputType: 'text' | 'url';\n    displayScale: number;\n    toggleInput: () => void;\n    toggleSidebar: () => void;\n    setShowSidebar: (show: boolean) => void;\n    setShowChangelog: (show: boolean) => void;\n    setShowPlanModal: (show: boolean) => void;\n    setShowSettings: (show: boolean) => void;\n    setInputType: (type: 'text' | 'url') => void;\n    setDisplayScale: (scale: number) => void;\n}\n\nexport const useUiStore = create<UiState>()(\n    persist(\n        (set) => ({\n            showInput: true,\n            showSidebar: true,\n            showChangelog: false,\n            showPlanModal: false,\n            showSettings: false,\n            inputType: 'url',\n            displayScale: 1.1,\n            toggleInput: () => set((state) => ({ showInput: !state.showInput })),\n            toggleSidebar: () => set((state) => ({ showSidebar: !state.showSidebar })),\n            setShowSidebar: (show) => set({ showSidebar: show }),\n            setShowChangelog: (show) => set({ showChangelog: show }),\n            setShowPlanModal: (show) => set({ showPlanModal: show }),\n            setShowSettings: (show) => set({ showSettings: show }),\n            setInputType: (type) => set({ inputType: type }),\n            setDisplayScale: (scale) => set({ displayScale: scale }),\n        }),\n        {\n            name: 'pro_content_writer_ui',\n            storage: createJSONStorage(() => localStorage),\n            partialize: (state) => ({\n                showInput: state.showInput,\n                showSidebar: state.showSidebar,\n                inputType: state.inputType,\n                displayScale: state.displayScale,\n            }),\n        }\n    )\n);\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAoBO,MAAM,aAAa,IAAA,kJAAM,IAC5B,IAAA,wJAAO,EACH,CAAC,MAAQ,CAAC;QACN,WAAW;QACX,aAAa;QACb,eAAe;QACf,eAAe;QACf,cAAc;QACd,WAAW;QACX,cAAc;QACd,aAAa,IAAM,IAAI,CAAC,QAAU,CAAC;oBAAE,WAAW,CAAC,MAAM,SAAS;gBAAC,CAAC;QAClE,eAAe,IAAM,IAAI,CAAC,QAAU,CAAC;oBAAE,aAAa,CAAC,MAAM,WAAW;gBAAC,CAAC;QACxE,gBAAgB,CAAC,OAAS,IAAI;gBAAE,aAAa;YAAK;QAClD,kBAAkB,CAAC,OAAS,IAAI;gBAAE,eAAe;YAAK;QACtD,kBAAkB,CAAC,OAAS,IAAI;gBAAE,eAAe;YAAK;QACtD,iBAAiB,CAAC,OAAS,IAAI;gBAAE,cAAc;YAAK;QACpD,cAAc,CAAC,OAAS,IAAI;gBAAE,WAAW;YAAK;QAC9C,iBAAiB,CAAC,QAAU,IAAI;gBAAE,cAAc;YAAM;IAC1D,CAAC,GACD;IACI,MAAM;IACN,SAAS,IAAA,kKAAiB,EAAC,IAAM;IACjC,YAAY,CAAC,QAAU,CAAC;YACpB,WAAW,MAAM,SAAS;YAC1B,aAAa,MAAM,WAAW;YAC9B,WAAW,MAAM,SAAS;YAC1B,cAAc,MAAM,YAAY;QACpC,CAAC;AACL"}},
    {"offset": {"line": 472, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/store/resetGenerationState.ts"],"sourcesContent":["import { useAnalysisStore } from './useAnalysisStore';\nimport { useGenerationStore } from './useGenerationStore';\nimport { useMetricsStore } from './useMetricsStore';\n\nexport const resetGenerationState = () => {\n    useGenerationStore.getState().resetGeneration();\n    useMetricsStore.getState().resetSessionStats();\n\n    // Clear editor autosave so a fresh analysis doesn't resurrect stale drafts\n    if (typeof window !== 'undefined') {\n        try {\n            localStorage.removeItem('ai_writer_editor_autosave_v1');\n        } catch (e) {\n            console.warn('Failed to clear editor autosave', e);\n        }\n    }\n\n    const analysis = useAnalysisStore.getState();\n    analysis.setKeywordPlans([]);\n    analysis.setRefAnalysis(null);\n    analysis.setAuthAnalysis(null);\n    analysis.setScrapedImages([]);\n    analysis.setVisualStyle('');\n    analysis.setCoveredPoints([]);\n    analysis.setProductMapping([]);\n    analysis.setActiveProductBrief(undefined);\n    analysis.setArticleTitle('');\n    analysis.setHeadingOptimizations([]);\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,MAAM,uBAAuB;IAChC,wJAAkB,CAAC,QAAQ,GAAG,eAAe;IAC7C,kJAAe,CAAC,QAAQ,GAAG,iBAAiB;IAE5C,2EAA2E;IAC3E;;IAQA,MAAM,WAAW,oJAAgB,CAAC,QAAQ;IAC1C,SAAS,eAAe,CAAC,EAAE;IAC3B,SAAS,cAAc,CAAC;IACxB,SAAS,eAAe,CAAC;IACzB,SAAS,gBAAgB,CAAC,EAAE;IAC5B,SAAS,cAAc,CAAC;IACxB,SAAS,gBAAgB,CAAC,EAAE;IAC5B,SAAS,iBAAiB,CAAC,EAAE;IAC7B,SAAS,qBAAqB,CAAC;IAC/B,SAAS,eAAe,CAAC;IACzB,SAAS,uBAAuB,CAAC,EAAE;AACvC"}},
    {"offset": {"line": 504, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/store/useSettingsStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { persist, createJSONStorage } from 'zustand/middleware';\nimport { MODEL, KEYWORD_CHAR_DIVISOR, MIN_KEYWORDS, SEMANTIC_KEYWORD_LIMIT } from '../config/constants';\n\ninterface SettingsState {\n    modelFlash: string;\n    modelImage: string;\n    keywordCharDivisor: number;\n    minKeywords: number;\n    maxKeywords: number;\n\n    // Actions\n    setModelFlash: (model: string) => void;\n    setModelImage: (model: string) => void;\n    setKeywordCharDivisor: (divisor: number) => void;\n    setMinKeywords: (min: number) => void;\n    setMaxKeywords: (max: number) => void;\n\n    // Reset\n    resetToDefaults: () => void;\n}\n\nexport const useSettingsStore = create<SettingsState>()(\n    persist(\n        (set) => ({\n            modelFlash: MODEL.FLASH,\n            modelImage: MODEL.IMAGE_PREVIEW,\n            keywordCharDivisor: KEYWORD_CHAR_DIVISOR,\n            minKeywords: MIN_KEYWORDS,\n            maxKeywords: SEMANTIC_KEYWORD_LIMIT,\n\n            setModelFlash: (model) => set({ modelFlash: model }),\n            setModelImage: (model) => set({ modelImage: model }),\n            setKeywordCharDivisor: (divisor) => set({ keywordCharDivisor: divisor }),\n            setMinKeywords: (min) => set({ minKeywords: min }),\n            setMaxKeywords: (max) => set({ maxKeywords: max }),\n\n            resetToDefaults: () => set({\n                modelFlash: MODEL.FLASH,\n                modelImage: MODEL.IMAGE_PREVIEW,\n                keywordCharDivisor: KEYWORD_CHAR_DIVISOR,\n                minKeywords: MIN_KEYWORDS,\n                maxKeywords: SEMANTIC_KEYWORD_LIMIT,\n            }),\n        }),\n        {\n            name: 'pro_content_writer_settings',\n            storage: createJSONStorage(() => localStorage),\n        }\n    )\n);\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAoBO,MAAM,mBAAmB,IAAA,kJAAM,IAClC,IAAA,wJAAO,EACH,CAAC,MAAQ,CAAC;QACN,YAAY,mIAAK,CAAC,KAAK;QACvB,YAAY,mIAAK,CAAC,aAAa;QAC/B,oBAAoB,kJAAoB;QACxC,aAAa,0IAAY;QACzB,aAAa,oJAAsB;QAEnC,eAAe,CAAC,QAAU,IAAI;gBAAE,YAAY;YAAM;QAClD,eAAe,CAAC,QAAU,IAAI;gBAAE,YAAY;YAAM;QAClD,uBAAuB,CAAC,UAAY,IAAI;gBAAE,oBAAoB;YAAQ;QACtE,gBAAgB,CAAC,MAAQ,IAAI;gBAAE,aAAa;YAAI;QAChD,gBAAgB,CAAC,MAAQ,IAAI;gBAAE,aAAa;YAAI;QAEhD,iBAAiB,IAAM,IAAI;gBACvB,YAAY,mIAAK,CAAC,KAAK;gBACvB,YAAY,mIAAK,CAAC,aAAa;gBAC/B,oBAAoB,kJAAoB;gBACxC,aAAa,0IAAY;gBACzB,aAAa,oJAAsB;YACvC;IACJ,CAAC,GACD;IACI,MAAM;IACN,SAAS,IAAA,kKAAiB,EAAC,IAAM;AACrC"}},
    {"offset": {"line": 550, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/utils/imageUtils.ts"],"sourcesContent":["import { ScrapedImage } from '../types';\n\nexport const toggleImage = (images: ScrapedImage[], imageToToggle: ScrapedImage): ScrapedImage[] => {\n    const keyToMatch = imageToToggle.id || imageToToggle.url || imageToToggle.altText;\n\n    return images.map((img, idx) => {\n        const key = img.id || img.url || img.altText || `${idx}`;\n        if (key !== keyToMatch) return img;\n        return { ...img, ignored: !img.ignored };\n    });\n};\n\nexport const getActiveImages = (images: ScrapedImage[]): ScrapedImage[] => {\n    return images.filter(img => !img.ignored);\n};\n\nconst buildKey = (img: ScrapedImage, idx: number) => {\n    if (img.url?.trim()) return `url:${img.url.trim()}`;\n    if (img.altText?.trim()) return `alt:${img.altText.trim()}`;\n    return `idx:${idx}`;\n};\n\n/**\n * Remove duplicate images while preserving the first occurrence order.\n * Prefers URL for uniqueness, then alt text as a fallback.\n */\nexport const dedupeScrapedImages = (images: ScrapedImage[]) => {\n    const seen = new Set<string>();\n    return images.filter((img, idx) => {\n        const key = buildKey(img, idx);\n        if (seen.has(key)) return false;\n        seen.add(key);\n        return true;\n    });\n};\n"],"names":[],"mappings":";;;;;;;;AAEO,MAAM,cAAc,CAAC,QAAwB;IAChD,MAAM,aAAa,cAAc,EAAE,IAAI,cAAc,GAAG,IAAI,cAAc,OAAO;IAEjF,OAAO,OAAO,GAAG,CAAC,CAAC,KAAK;QACpB,MAAM,MAAM,IAAI,EAAE,IAAI,IAAI,GAAG,IAAI,IAAI,OAAO,IAAI,GAAG,KAAK;QACxD,IAAI,QAAQ,YAAY,OAAO;QAC/B,OAAO;YAAE,GAAG,GAAG;YAAE,SAAS,CAAC,IAAI,OAAO;QAAC;IAC3C;AACJ;AAEO,MAAM,kBAAkB,CAAC;IAC5B,OAAO,OAAO,MAAM,CAAC,CAAA,MAAO,CAAC,IAAI,OAAO;AAC5C;AAEA,MAAM,WAAW,CAAC,KAAmB;IACjC,IAAI,IAAI,GAAG,EAAE,QAAQ,OAAO,CAAC,IAAI,EAAE,IAAI,GAAG,CAAC,IAAI,IAAI;IACnD,IAAI,IAAI,OAAO,EAAE,QAAQ,OAAO,CAAC,IAAI,EAAE,IAAI,OAAO,CAAC,IAAI,IAAI;IAC3D,OAAO,CAAC,IAAI,EAAE,KAAK;AACvB;AAMO,MAAM,sBAAsB,CAAC;IAChC,MAAM,OAAO,IAAI;IACjB,OAAO,OAAO,MAAM,CAAC,CAAC,KAAK;QACvB,MAAM,MAAM,SAAS,KAAK;QAC1B,IAAI,KAAK,GAAG,CAAC,MAAM,OAAO;QAC1B,KAAK,GAAG,CAAC;QACT,OAAO;IACX;AACJ"}},
    {"offset": {"line": 590, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/utils/cn.ts"],"sourcesContent":["import { ClassValue, clsx } from 'clsx';\nimport { twMerge } from 'tailwind-merge';\n\nexport const cn = (...inputs: ClassValue[]) => twMerge(clsx(inputs));\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,MAAM,KAAK,CAAC,GAAG,SAAyB,IAAA,sKAAO,EAAC,IAAA,6IAAI,EAAC"}},
    {"offset": {"line": 603, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/utils/logger.ts"],"sourcesContent":["export type LogStage =\n    | 'init'\n    | 'parsing_product'\n    | 'mapping_product'\n    | 'nlp_analysis'\n    | 'planning_keywords'\n    | 'extracting_structure'\n    | 'analyzing_visuals'\n    | 'writing_content'\n    | 'refining_headings'\n    | 'finalizing'\n    | 'error'\n    | 'idle';\n\ninterface LogEntry {\n    stage: LogStage;\n    msg: string;\n    meta?: Record<string, any>;\n    duration?: number;\n}\n\ntype LogListener = (entry: LogEntry) => void;\n\nclass Logger {\n    private listeners: LogListener[] = [];\n\n    subscribe(listener: LogListener) {\n        this.listeners.push(listener);\n        return () => {\n            this.listeners = this.listeners.filter(l => l !== listener);\n        };\n    }\n\n    log(stage: LogStage, msg: string, meta?: Record<string, any>, duration?: number) {\n        const entry: LogEntry = { stage, msg, meta, duration };\n\n        // Console output\n        const durationStr = duration ? ` (${duration}ms)` : '';\n        const metaStr = meta ? ` ${JSON.stringify(meta)}` : '';\n        console.log(`[${stage}] ${msg}${durationStr}${metaStr}`);\n\n        // Notify listeners (e.g., UI)\n        this.listeners.forEach(l => l(entry));\n    }\n\n    warn(stage: LogStage, msg: string, error?: unknown) {\n        console.warn(`[${stage}] ${msg}`, error);\n        this.listeners.forEach(l => l({ stage, msg: `WARNING: ${msg}`, meta: { error } }));\n    }\n\n    error(stage: LogStage, msg: string, error?: unknown) {\n        console.error(`[${stage}] ${msg}`, error);\n        this.listeners.forEach(l => l({ stage, msg: `ERROR: ${msg}`, meta: { error } }));\n    }\n}\n\nexport const logger = new Logger();\n"],"names":[],"mappings":";;;;AAuBA,MAAM;IACM,YAA2B,EAAE,CAAC;IAEtC,UAAU,QAAqB,EAAE;QAC7B,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC;QACpB,OAAO;YACH,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAA,IAAK,MAAM;QACtD;IACJ;IAEA,IAAI,KAAe,EAAE,GAAW,EAAE,IAA0B,EAAE,QAAiB,EAAE;QAC7E,MAAM,QAAkB;YAAE;YAAO;YAAK;YAAM;QAAS;QAErD,iBAAiB;QACjB,MAAM,cAAc,WAAW,CAAC,EAAE,EAAE,SAAS,GAAG,CAAC,GAAG;QACpD,MAAM,UAAU,OAAO,CAAC,CAAC,EAAE,KAAK,SAAS,CAAC,OAAO,GAAG;QACpD,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,MAAM,EAAE,EAAE,MAAM,cAAc,SAAS;QAEvD,8BAA8B;QAC9B,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAAA,IAAK,EAAE;IAClC;IAEA,KAAK,KAAe,EAAE,GAAW,EAAE,KAAe,EAAE;QAChD,QAAQ,IAAI,CAAC,CAAC,CAAC,EAAE,MAAM,EAAE,EAAE,KAAK,EAAE;QAClC,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAAA,IAAK,EAAE;gBAAE;gBAAO,KAAK,CAAC,SAAS,EAAE,KAAK;gBAAE,MAAM;oBAAE;gBAAM;YAAE;IACnF;IAEA,MAAM,KAAe,EAAE,GAAW,EAAE,KAAe,EAAE;QACjD,QAAQ,KAAK,CAAC,CAAC,CAAC,EAAE,MAAM,EAAE,EAAE,KAAK,EAAE;QACnC,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAAA,IAAK,EAAE;gBAAE;gBAAO,KAAK,CAAC,OAAO,EAAE,KAAK;gBAAE,MAAM;oBAAE;gBAAM;YAAE;IACjF;AACJ;AAEO,MAAM,SAAS,IAAI"}},
    {"offset": {"line": 655, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/utils/textUtils.ts"],"sourcesContent":["export const cleanHeadingText = (value: string | undefined): string => {\n    return (value || '')\n        .replace(/^#+\\s*/, '')\n        .replace(/[\"“”]/g, '')\n        .trim();\n};\n\nexport const stripLeadingHeading = (content: string): string => {\n    if (!content) return '';\n    // Remove a leading H1/H2/H3 tag or markdown heading to avoid duplicates after we inject headings ourselves.\n    const withoutHtmlHeading = content.replace(/^\\s*<h[1-6][^>]*>.*?<\\/h[1-6]>\\s*/i, '');\n    const withoutMdHeading = withoutHtmlHeading.replace(/^\\s*#{1,6}\\s.*(\\r?\\n|$)/, '');\n    return withoutMdHeading.trim();\n};\n"],"names":[],"mappings":";;;;;;AAAO,MAAM,mBAAmB,CAAC;IAC7B,OAAO,CAAC,SAAS,EAAE,EACd,OAAO,CAAC,UAAU,IAClB,OAAO,CAAC,UAAU,IAClB,IAAI;AACb;AAEO,MAAM,sBAAsB,CAAC;IAChC,IAAI,CAAC,SAAS,OAAO;IACrB,4GAA4G;IAC5G,MAAM,qBAAqB,QAAQ,OAAO,CAAC,sCAAsC;IACjF,MAAM,mBAAmB,mBAAmB,OAAO,CAAC,2BAA2B;IAC/E,OAAO,iBAAiB,IAAI;AAChC"}},
    {"offset": {"line": 675, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/schemas/formSchema.ts"],"sourcesContent":["import { z } from 'zod';\n\nexport const articleFormSchema = z.object({\n    title: z.string().min(1, \"Topic is required\"),\n    referenceContent: z.string().min(50, \"Reference content must be at least 50 characters\"),\n    sampleOutline: z.string().optional(),\n    authorityTerms: z.string().optional(),\n    websiteType: z.string().optional(),\n    targetAudience: z.enum(['zh-TW', 'zh-HK', 'zh-MY']),\n    useRag: z.boolean(),\n    autoImagePlan: z.boolean(),\n    productRawText: z.string().optional(),\n\n    // UI-only fields that might need validation if used\n    urlInput: z.string().url(\"Invalid URL\").optional().or(z.literal('')),\n    productUrlList: z.string().optional(),\n});\n\nexport type ArticleFormValues = z.infer<typeof articleFormSchema>;\n"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,oBAAoB,kLAAC,CAAC,MAAM,CAAC;IACtC,OAAO,kLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACzB,kBAAkB,kLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,IAAI;IACrC,eAAe,kLAAC,CAAC,MAAM,GAAG,QAAQ;IAClC,gBAAgB,kLAAC,CAAC,MAAM,GAAG,QAAQ;IACnC,aAAa,kLAAC,CAAC,MAAM,GAAG,QAAQ;IAChC,gBAAgB,kLAAC,CAAC,IAAI,CAAC;QAAC;QAAS;QAAS;KAAQ;IAClD,QAAQ,kLAAC,CAAC,OAAO;IACjB,eAAe,kLAAC,CAAC,OAAO;IACxB,gBAAgB,kLAAC,CAAC,MAAM,GAAG,QAAQ;IAEnC,oDAAoD;IACpD,UAAU,kLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,eAAe,QAAQ,GAAG,EAAE,CAAC,kLAAC,CAAC,OAAO,CAAC;IAChE,gBAAgB,kLAAC,CAAC,MAAM,GAAG,QAAQ;AACvC"}},
    {"offset": {"line": 703, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useUrlScraper.ts"],"sourcesContent":["import { useCallback, useState } from 'react';\nimport { UseFormSetValue } from 'react-hook-form';\nimport { useMutation } from '@tanstack/react-query';\nimport { fetchUrlContent } from '../services/research/webScraper';\nimport { extractWebsiteTypeAndTerm } from '../services/research/referenceAnalysisService';\nimport { ArticleFormValues } from '../schemas/formSchema';\nimport { CostBreakdown, ScrapedImage, TokenUsage } from '../types';\nimport { dedupeScrapedImages } from '../utils/imageUtils';\n\ninterface UseUrlScraperParams {\n    setValue: UseFormSetValue<ArticleFormValues>;\n    onAddCost?: (cost: CostBreakdown, usage: TokenUsage) => void;\n    setInputType: (type: 'text' | 'url') => void;\n}\n\nexport const useUrlScraper = ({\n    setValue,\n    onAddCost,\n    setInputType,\n}: UseUrlScraperParams) => {\n    const [scrapedImages, setScrapedImages] = useState<ScrapedImage[]>([]);\n    const mutation = useMutation({\n        mutationFn: async (url: string) => {\n            if (!url) throw new Error('URL is required');\n            const { title, content, images } = await fetchUrlContent(url);\n            return { title, content, images };\n        },\n        onSuccess: async ({ title, content, images }) => {\n            setValue('referenceContent', content);\n            setScrapedImages(dedupeScrapedImages(images));\n            if (title) setValue('title', title);\n\n            try {\n                const brandRes = await extractWebsiteTypeAndTerm(content);\n                if (brandRes.data.websiteType) setValue('websiteType', brandRes.data.websiteType);\n                if (brandRes.data.authorityTerms) setValue('authorityTerms', brandRes.data.authorityTerms);\n                if (onAddCost) onAddCost(brandRes.cost, brandRes.usage);\n            } catch (aiError) {\n                console.warn('Failed to auto-extract brand info', aiError);\n            }\n            setInputType('text');\n        },\n        onError: () => {\n            alert('Failed to fetch content from URL. The site might block bots.');\n        }\n    });\n\n    const fetchAndPopulate = useCallback(async (url: string) => {\n        await mutation.mutateAsync(url);\n    }, [mutation]);\n\n    return {\n        scrapedImages,\n        setScrapedImages,\n        isFetchingUrl: mutation.isPending,\n        fetchAndPopulate,\n    };\n};\n"],"names":[],"mappings":";;;;AAAA;AAEA;AACA;AACA;AAGA;;;;;;AAQO,MAAM,gBAAgB,CAAC,EAC1B,QAAQ,EACR,SAAS,EACT,YAAY,EACM;IAClB,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,iNAAQ,EAAiB,EAAE;IACrE,MAAM,WAAW,IAAA,6LAAW,EAAC;QACzB,YAAY,OAAO;YACf,IAAI,CAAC,KAAK,MAAM,IAAI,MAAM;YAC1B,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,MAAM,EAAE,GAAG,MAAM,IAAA,4JAAe,EAAC;YACzD,OAAO;gBAAE;gBAAO;gBAAS;YAAO;QACpC;QACA,WAAW,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,MAAM,EAAE;YACxC,SAAS,oBAAoB;YAC7B,iBAAiB,IAAA,iJAAmB,EAAC;YACrC,IAAI,OAAO,SAAS,SAAS;YAE7B,IAAI;gBACA,MAAM,WAAW,MAAM,IAAA,oLAAyB,EAAC;gBACjD,IAAI,SAAS,IAAI,CAAC,WAAW,EAAE,SAAS,eAAe,SAAS,IAAI,CAAC,WAAW;gBAChF,IAAI,SAAS,IAAI,CAAC,cAAc,EAAE,SAAS,kBAAkB,SAAS,IAAI,CAAC,cAAc;gBACzF,IAAI,WAAW,UAAU,SAAS,IAAI,EAAE,SAAS,KAAK;YAC1D,EAAE,OAAO,SAAS;gBACd,QAAQ,IAAI,CAAC,qCAAqC;YACtD;YACA,aAAa;QACjB;QACA,SAAS;YACL,MAAM;QACV;IACJ;IAEA,MAAM,mBAAmB,IAAA,oNAAW,EAAC,OAAO;QACxC,MAAM,SAAS,WAAW,CAAC;IAC/B,GAAG;QAAC;KAAS;IAEb,OAAO;QACH;QACA;QACA,eAAe,SAAS,SAAS;QACjC;IACJ;AACJ"}},
    {"offset": {"line": 763, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useProfileManager.ts"],"sourcesContent":["import { useCallback } from 'react';\nimport { UseFormSetValue } from 'react-hook-form';\nimport { ArticleFormValues } from '../schemas/formSchema';\nimport { SavedProfile } from '../types';\n\ninterface ProfileManagerParams {\n    savedProfiles?: SavedProfile[];\n    setSavedProfiles?: (profiles: SavedProfile[]) => void;\n    activeProfile?: SavedProfile | null;\n    onSetActiveProfile?: (profile: SavedProfile | null) => void;\n    brandKnowledge?: string;\n    setValue: UseFormSetValue<ArticleFormValues>;\n}\n\nexport const useProfileManager = ({\n    savedProfiles = [],\n    setSavedProfiles,\n    activeProfile,\n    onSetActiveProfile,\n    brandKnowledge,\n    setValue,\n}: ProfileManagerParams) => {\n\n    const createProfile = useCallback((name: string, values: ArticleFormValues) => {\n        if (!setSavedProfiles || !name.trim()) return null;\n\n        const newProfile: SavedProfile = {\n            id: Date.now().toString(),\n            name: name.trim(),\n            websiteType: values.websiteType || '',\n            authorityTerms: values.authorityTerms || '',\n            brandKnowledge: brandKnowledge || '',\n            targetAudience: values.targetAudience,\n            useRag: values.useRag,\n            productRawText: values.productRawText\n        };\n\n        const updated = [...savedProfiles, newProfile];\n        setSavedProfiles(updated);\n        onSetActiveProfile?.(newProfile);\n        return newProfile;\n    }, [brandKnowledge, onSetActiveProfile, savedProfiles, setSavedProfiles]);\n\n    const updateProfile = useCallback((values: ArticleFormValues) => {\n        if (!setSavedProfiles || !activeProfile) return null;\n\n        const updatedProfiles = savedProfiles.map(p => p.id === activeProfile.id ? {\n            ...p,\n            websiteType: values.websiteType || '',\n            authorityTerms: values.authorityTerms || '',\n            targetAudience: values.targetAudience,\n            useRag: values.useRag,\n            productRawText: values.productRawText,\n            brandKnowledge: brandKnowledge\n        } : p);\n\n        setSavedProfiles(updatedProfiles);\n        const updatedActive = updatedProfiles.find(p => p.id === activeProfile.id) || null;\n        onSetActiveProfile?.(updatedActive);\n        return updatedActive;\n    }, [activeProfile, brandKnowledge, onSetActiveProfile, savedProfiles, setSavedProfiles]);\n\n    const deleteProfile = useCallback((id: string) => {\n        if (!setSavedProfiles) return;\n        const updatedProfiles = savedProfiles.filter(p => p.id !== id);\n        setSavedProfiles(updatedProfiles);\n        if (activeProfile?.id === id) {\n            onSetActiveProfile?.(null);\n        }\n    }, [activeProfile?.id, onSetActiveProfile, savedProfiles, setSavedProfiles]);\n\n    const applyProfileToForm = useCallback((profile: SavedProfile) => {\n        setValue('websiteType', profile.websiteType);\n        setValue('authorityTerms', profile.authorityTerms);\n        setValue('targetAudience', profile.targetAudience);\n        if (profile.useRag !== undefined) setValue('useRag', profile.useRag);\n\n        if (profile.productRawText) {\n            setValue('productRawText', profile.productRawText);\n        } else if (profile.productBrief) {\n            setValue('productRawText', `${profile.productBrief.productName} - ${profile.productBrief.usp}. Link: ${profile.productBrief.ctaLink}`);\n        }\n\n        onSetActiveProfile?.(profile);\n    }, [onSetActiveProfile, setValue]);\n\n    const loadProductFromProfile = useCallback((profile: SavedProfile) => {\n        if (profile.productRawText) {\n            setValue('productRawText', profile.productRawText);\n        } else if (profile.productBrief) {\n            setValue('productRawText', `${profile.productBrief.productName} - ${profile.productBrief.usp}. Link: ${profile.productBrief.ctaLink}`);\n        } else {\n            alert('This profile has no saved product/service details.');\n        }\n    }, [setValue]);\n\n    return {\n        createProfile,\n        updateProfile,\n        deleteProfile,\n        applyProfileToForm,\n        loadProductFromProfile,\n    };\n};\n"],"names":[],"mappings":";;;;AAAA;;AAcO,MAAM,oBAAoB,CAAC,EAC9B,gBAAgB,EAAE,EAClB,gBAAgB,EAChB,aAAa,EACb,kBAAkB,EAClB,cAAc,EACd,QAAQ,EACW;IAEnB,MAAM,gBAAgB,IAAA,oNAAW,EAAC,CAAC,MAAc;QAC7C,IAAI,CAAC,oBAAoB,CAAC,KAAK,IAAI,IAAI,OAAO;QAE9C,MAAM,aAA2B;YAC7B,IAAI,KAAK,GAAG,GAAG,QAAQ;YACvB,MAAM,KAAK,IAAI;YACf,aAAa,OAAO,WAAW,IAAI;YACnC,gBAAgB,OAAO,cAAc,IAAI;YACzC,gBAAgB,kBAAkB;YAClC,gBAAgB,OAAO,cAAc;YACrC,QAAQ,OAAO,MAAM;YACrB,gBAAgB,OAAO,cAAc;QACzC;QAEA,MAAM,UAAU;eAAI;YAAe;SAAW;QAC9C,iBAAiB;QACjB,qBAAqB;QACrB,OAAO;IACX,GAAG;QAAC;QAAgB;QAAoB;QAAe;KAAiB;IAExE,MAAM,gBAAgB,IAAA,oNAAW,EAAC,CAAC;QAC/B,IAAI,CAAC,oBAAoB,CAAC,eAAe,OAAO;QAEhD,MAAM,kBAAkB,cAAc,GAAG,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,cAAc,EAAE,GAAG;gBACvE,GAAG,CAAC;gBACJ,aAAa,OAAO,WAAW,IAAI;gBACnC,gBAAgB,OAAO,cAAc,IAAI;gBACzC,gBAAgB,OAAO,cAAc;gBACrC,QAAQ,OAAO,MAAM;gBACrB,gBAAgB,OAAO,cAAc;gBACrC,gBAAgB;YACpB,IAAI;QAEJ,iBAAiB;QACjB,MAAM,gBAAgB,gBAAgB,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,cAAc,EAAE,KAAK;QAC9E,qBAAqB;QACrB,OAAO;IACX,GAAG;QAAC;QAAe;QAAgB;QAAoB;QAAe;KAAiB;IAEvF,MAAM,gBAAgB,IAAA,oNAAW,EAAC,CAAC;QAC/B,IAAI,CAAC,kBAAkB;QACvB,MAAM,kBAAkB,cAAc,MAAM,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;QAC3D,iBAAiB;QACjB,IAAI,eAAe,OAAO,IAAI;YAC1B,qBAAqB;QACzB;IACJ,GAAG;QAAC,eAAe;QAAI;QAAoB;QAAe;KAAiB;IAE3E,MAAM,qBAAqB,IAAA,oNAAW,EAAC,CAAC;QACpC,SAAS,eAAe,QAAQ,WAAW;QAC3C,SAAS,kBAAkB,QAAQ,cAAc;QACjD,SAAS,kBAAkB,QAAQ,cAAc;QACjD,IAAI,QAAQ,MAAM,KAAK,WAAW,SAAS,UAAU,QAAQ,MAAM;QAEnE,IAAI,QAAQ,cAAc,EAAE;YACxB,SAAS,kBAAkB,QAAQ,cAAc;QACrD,OAAO,IAAI,QAAQ,YAAY,EAAE;YAC7B,SAAS,kBAAkB,GAAG,QAAQ,YAAY,CAAC,WAAW,CAAC,GAAG,EAAE,QAAQ,YAAY,CAAC,GAAG,CAAC,QAAQ,EAAE,QAAQ,YAAY,CAAC,OAAO,EAAE;QACzI;QAEA,qBAAqB;IACzB,GAAG;QAAC;QAAoB;KAAS;IAEjC,MAAM,yBAAyB,IAAA,oNAAW,EAAC,CAAC;QACxC,IAAI,QAAQ,cAAc,EAAE;YACxB,SAAS,kBAAkB,QAAQ,cAAc;QACrD,OAAO,IAAI,QAAQ,YAAY,EAAE;YAC7B,SAAS,kBAAkB,GAAG,QAAQ,YAAY,CAAC,WAAW,CAAC,GAAG,EAAE,QAAQ,YAAY,CAAC,GAAG,CAAC,QAAQ,EAAE,QAAQ,YAAY,CAAC,OAAO,EAAE;QACzI,OAAO;YACH,MAAM;QACV;IACJ,GAAG;QAAC;KAAS;IAEb,OAAO;QACH;QACA;QACA;QACA;QACA;IACJ;AACJ"}},
    {"offset": {"line": 868, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useStorageReset.ts"],"sourcesContent":["interface ClearOptions {\n    reload?: boolean;\n    includeForm?: boolean;\n}\n\nconst CLEAR_KEYS = [\n    'pro_content_writer_analysis',\n    'pro_content_writer_generation',\n    'ai_writer_editor_autosave_v1'\n];\n\nexport const useStorageReset = () => {\n    const clearAll = ({ reload = true, includeForm = true }: ClearOptions = {}) => {\n        if (typeof window === 'undefined') return;\n        try {\n            const keys = [...CLEAR_KEYS];\n            if (includeForm) keys.push('pro_content_writer_inputs_simple_v4');\n            keys.forEach(k => localStorage.removeItem(k));\n            sessionStorage.removeItem('autosave_restore_decision');\n        } catch (e) {\n            console.warn('Failed to clear storage', e);\n        }\n        if (reload) window.location.reload();\n    };\n\n    return { clearAll };\n};\n"],"names":[],"mappings":";;;;AAKA,MAAM,aAAa;IACf;IACA;IACA;CACH;AAEM,MAAM,kBAAkB;IAC3B,MAAM,WAAW,CAAC,EAAE,SAAS,IAAI,EAAE,cAAc,IAAI,EAAgB,GAAG,CAAC,CAAC;QACtE,wCAAmC;;;IAUvC;IAEA,OAAO;QAAE;IAAS;AACtB"}},
    {"offset": {"line": 891, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useArticleForm.ts"],"sourcesContent":["import { useCallback, useEffect, useMemo, useState } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { articleFormSchema, ArticleFormValues } from '../schemas/formSchema';\nimport { SavedProfile, ScrapedImage } from '../types';\nimport { useUrlScraper } from './useUrlScraper';\nimport { useProfileManager } from './useProfileManager';\nimport { useStorageReset } from './useStorageReset';\nimport { dedupeScrapedImages } from '../utils/imageUtils';\n\nconst STORAGE_KEY = 'pro_content_writer_inputs_simple_v4';\n\ninterface UseArticleFormParams {\n    brandKnowledge?: string;\n    savedProfiles?: SavedProfile[];\n    setSavedProfiles?: (profiles: SavedProfile[]) => void;\n    activeProfile?: SavedProfile | null;\n    onSetActiveProfile?: (profile: SavedProfile | null) => void;\n    setInputType: (type: 'text' | 'url') => void;\n}\n\nexport const useArticleForm = ({\n    brandKnowledge = '',\n    savedProfiles = [],\n    setSavedProfiles,\n    activeProfile,\n    onSetActiveProfile,\n    setInputType,\n}: UseArticleFormParams) => {\n    const {\n        register,\n        handleSubmit,\n        setValue,\n        watch,\n        reset,\n        formState: { errors }\n    } = useForm<ArticleFormValues>({\n        resolver: zodResolver(articleFormSchema),\n        defaultValues: {\n            title: '',\n            referenceContent: '',\n            sampleOutline: '',\n            authorityTerms: '',\n            websiteType: '',\n            targetAudience: 'zh-TW',\n            useRag: false,\n            autoImagePlan: false,\n            productRawText: '',\n            urlInput: '',\n            productUrlList: ''\n        }\n    });\n\n    const watchedValues = watch();\n\n    const [productMode, setProductMode] = useState<'text' | 'url'>('text');\n    const [isSummarizingProduct, setIsSummarizingProduct] = useState(false);\n    const [refCharCount, setRefCharCount] = useState(0);\n    const [refWordCount, setRefWordCount] = useState(0);\n    const { clearAll } = useStorageReset();\n\n    const {\n        scrapedImages,\n        setScrapedImages,\n        isFetchingUrl,\n        fetchAndPopulate\n    } = useUrlScraper({\n        setValue,\n        setInputType,\n    });\n\n    const {\n        createProfile,\n        updateProfile,\n        deleteProfile,\n        applyProfileToForm,\n        loadProductFromProfile,\n    } = useProfileManager({\n        savedProfiles,\n        setSavedProfiles,\n        activeProfile,\n        onSetActiveProfile,\n        brandKnowledge,\n        setValue,\n    });\n\n    // Restore persisted form\n    useEffect(() => {\n        if (typeof window === 'undefined') return;\n        const saved = localStorage.getItem(STORAGE_KEY);\n        if (saved) {\n            try {\n                const parsed = JSON.parse(saved);\n                Object.keys(parsed).forEach(key => {\n                    // @ts-ignore\n                    setValue(key, parsed[key]);\n                });\n                if (parsed.scrapedImages) setScrapedImages(dedupeScrapedImages(parsed.scrapedImages));\n            } catch (e) {\n                console.warn('Failed to restore persisted form', e);\n            }\n        }\n    }, [setScrapedImages, setValue]);\n\n    // Persist + counts\n    useEffect(() => {\n        const subscription = watch((values) => {\n            const dataToSave = { ...values, scrapedImages };\n            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));\n\n            const content = values.referenceContent || '';\n            setRefCharCount(content.length);\n            const cjkCount = (content.match(/[\\u4e00-\\u9fa5]/g) || []).length;\n            const nonCjkText = content.replace(/[\\u4e00-\\u9fa5]/g, ' ');\n            const englishWords = nonCjkText.trim().split(/\\s+/).filter(w => w.length > 0);\n            setRefWordCount(cjkCount + englishWords.length);\n        });\n        return () => subscription.unsubscribe();\n    }, [scrapedImages, watch]);\n\n    // Apply active profile\n    useEffect(() => {\n        if (activeProfile) {\n            applyProfileToForm(activeProfile);\n        }\n    }, [activeProfile, applyProfileToForm]);\n\n    const usableImages = useMemo(() => scrapedImages.filter(img => !img.ignored), [scrapedImages]);\n\n    const handleClear = useCallback(() => {\n        if (typeof window === 'undefined') return;\n        if (!confirm('確定要清空所有輸入與紀錄嗎？\\n這會重置表單、分析與草稿，並重新整理頁面。')) return;\n        reset();\n        setScrapedImages([]);\n        setValue('targetAudience', 'zh-TW');\n        clearAll({ reload: true, includeForm: true });\n    }, [clearAll, reset, setScrapedImages, setValue]);\n\n    return {\n        register,\n        handleSubmit,\n        setValue,\n        watchedValues,\n        errors,\n        productMode,\n        setProductMode,\n        isSummarizingProduct,\n        setIsSummarizingProduct,\n        refCharCount,\n        refWordCount,\n        scrapedImages,\n        setScrapedImages,\n        isFetchingUrl,\n        fetchAndPopulate,\n        createProfile,\n        updateProfile,\n        deleteProfile,\n        applyProfileToForm,\n        loadProductFromProfile,\n        usableImages,\n        handleClear,\n    };\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;;;;;;;;AAEA,MAAM,cAAc;AAWb,MAAM,iBAAiB,CAAC,EAC3B,iBAAiB,EAAE,EACnB,gBAAgB,EAAE,EAClB,gBAAgB,EAChB,aAAa,EACb,kBAAkB,EAClB,YAAY,EACO;IACnB,MAAM,EACF,QAAQ,EACR,YAAY,EACZ,QAAQ,EACR,KAAK,EACL,KAAK,EACL,WAAW,EAAE,MAAM,EAAE,EACxB,GAAG,IAAA,yKAAO,EAAoB;QAC3B,UAAU,IAAA,6KAAW,EAAC,iJAAiB;QACvC,eAAe;YACX,OAAO;YACP,kBAAkB;YAClB,eAAe;YACf,gBAAgB;YAChB,aAAa;YACb,gBAAgB;YAChB,QAAQ;YACR,eAAe;YACf,gBAAgB;YAChB,UAAU;YACV,gBAAgB;QACpB;IACJ;IAEA,MAAM,gBAAgB;IAEtB,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,iNAAQ,EAAiB;IAC/D,MAAM,CAAC,sBAAsB,wBAAwB,GAAG,IAAA,iNAAQ,EAAC;IACjE,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,iNAAQ,EAAC;IACjD,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,iNAAQ,EAAC;IACjD,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAA,kJAAe;IAEpC,MAAM,EACF,aAAa,EACb,gBAAgB,EAChB,aAAa,EACb,gBAAgB,EACnB,GAAG,IAAA,8IAAa,EAAC;QACd;QACA;IACJ;IAEA,MAAM,EACF,aAAa,EACb,aAAa,EACb,aAAa,EACb,kBAAkB,EAClB,sBAAsB,EACzB,GAAG,IAAA,sJAAiB,EAAC;QAClB;QACA;QACA;QACA;QACA;QACA;IACJ;IAEA,yBAAyB;IACzB,IAAA,kNAAS,EAAC;QACN,wCAAmC;;;QACnC,MAAM;IAaV,GAAG;QAAC;QAAkB;KAAS;IAE/B,mBAAmB;IACnB,IAAA,kNAAS,EAAC;QACN,MAAM,eAAe,MAAM,CAAC;YACxB,MAAM,aAAa;gBAAE,GAAG,MAAM;gBAAE;YAAc;YAC9C,aAAa,OAAO,CAAC,aAAa,KAAK,SAAS,CAAC;YAEjD,MAAM,UAAU,OAAO,gBAAgB,IAAI;YAC3C,gBAAgB,QAAQ,MAAM;YAC9B,MAAM,WAAW,CAAC,QAAQ,KAAK,CAAC,uBAAuB,EAAE,EAAE,MAAM;YACjE,MAAM,aAAa,QAAQ,OAAO,CAAC,oBAAoB;YACvD,MAAM,eAAe,WAAW,IAAI,GAAG,KAAK,CAAC,OAAO,MAAM,CAAC,CAAA,IAAK,EAAE,MAAM,GAAG;YAC3E,gBAAgB,WAAW,aAAa,MAAM;QAClD;QACA,OAAO,IAAM,aAAa,WAAW;IACzC,GAAG;QAAC;QAAe;KAAM;IAEzB,uBAAuB;IACvB,IAAA,kNAAS,EAAC;QACN,IAAI,eAAe;YACf,mBAAmB;QACvB;IACJ,GAAG;QAAC;QAAe;KAAmB;IAEtC,MAAM,eAAe,IAAA,gNAAO,EAAC,IAAM,cAAc,MAAM,CAAC,CAAA,MAAO,CAAC,IAAI,OAAO,GAAG;QAAC;KAAc;IAE7F,MAAM,cAAc,IAAA,oNAAW,EAAC;QAC5B,wCAAmC;;;IAMvC,GAAG;QAAC;QAAU;QAAO;QAAkB;KAAS;IAEhD,OAAO;QACH;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;IACJ;AACJ"}},
    {"offset": {"line": 1028, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useSemanticFilter.ts"],"sourcesContent":["import { useState, useCallback } from 'react';\nimport { embedTexts, cosineSimilarity } from '../services/engine/embeddingService';\n\nconst DEFAULT_SEMANTIC_THRESHOLD = 0.79;\n\nconst splitIntoBlankLineChunks = (content: string): string[] =>\n    content\n        .split(/\\n\\s*\\n+/)\n        .map(chunk => chunk.trim())\n        .filter(Boolean);\n\nexport const useSemanticFilter = () => {\n    const [isChunkModalOpen, setIsChunkModalOpen] = useState(false);\n    const [chunkPreview, setChunkPreview] = useState<string[]>([]);\n    const [isFilteringChunks, setIsFilteringChunks] = useState(false);\n    const [filterError, setFilterError] = useState<string | null>(null);\n    const [chunkScores, setChunkScores] = useState<number[]>([]);\n    const [isScoringChunks, setIsScoringChunks] = useState(false);\n    const [manualKeep, setManualKeep] = useState<Record<number, boolean>>({});\n    const [semanticThreshold, setSemanticThreshold] = useState<number>(DEFAULT_SEMANTIC_THRESHOLD);\n    const [semanticThresholdInput, setSemanticThresholdInput] = useState<string>(DEFAULT_SEMANTIC_THRESHOLD.toString());\n\n    const commitSemanticThreshold = useCallback((raw?: string) => {\n        const candidate = (typeof raw === 'string' ? raw : semanticThresholdInput).trim();\n        if (candidate === '') {\n            setSemanticThresholdInput(semanticThreshold.toString());\n            return semanticThreshold;\n        }\n\n        const parsed = parseFloat(candidate);\n        if (Number.isNaN(parsed)) {\n            setSemanticThresholdInput(semanticThreshold.toString());\n            return semanticThreshold;\n        }\n\n        const clamped = Math.min(1, Math.max(0, parsed));\n        const normalized = Math.round(clamped * 100) / 100;\n        setSemanticThreshold(normalized);\n        setSemanticThresholdInput(normalized.toString());\n        return normalized;\n    }, [semanticThresholdInput, semanticThreshold]);\n\n    const scoreChunks = useCallback(async (chunks: string[], title: string) => {\n        if (!title) {\n            setFilterError('請先填寫標題，再計算語意距離。');\n            return null;\n        }\n\n        setIsScoringChunks(true);\n        setFilterError(null);\n\n        try {\n            const [titleEmbeddings, chunkEmbeddings] = await Promise.all([\n                embedTexts([title]),\n                embedTexts(chunks),\n            ]);\n\n            const titleEmbedding = titleEmbeddings[0];\n            if (!titleEmbedding?.length) {\n                throw new Error('無法取得標題向量，請稍後再試。');\n            }\n\n            const similarities = chunks.map((chunk, idx) => {\n                const chunkEmbedding = chunkEmbeddings[idx];\n                if (!chunkEmbedding?.length) return 1;\n                return cosineSimilarity(titleEmbedding, chunkEmbedding);\n            });\n\n            setChunkScores(similarities);\n            return similarities;\n        } catch (error: any) {\n            setFilterError(error?.message || '語意過濾失敗，請稍後再試。');\n            return null;\n        } finally {\n            setIsScoringChunks(false);\n        }\n    }, []);\n\n    const openFilterModal = useCallback((content: string, title: string) => {\n        const chunks = splitIntoBlankLineChunks(content);\n        if (!chunks.length) {\n            alert('找不到可以分段的內容（需有空白行分隔）。');\n            return;\n        }\n\n        setChunkPreview(chunks);\n        setFilterError(null);\n        setChunkScores([]);\n        setManualKeep({});\n        setIsChunkModalOpen(true);\n        void scoreChunks(chunks, title);\n    }, [scoreChunks]);\n\n    const applyFilter = useCallback(async (content: string, title: string): Promise<string | null> => {\n        const chunks = chunkPreview.length ? chunkPreview : splitIntoBlankLineChunks(content);\n        if (!chunks.length) {\n            setFilterError('找不到可用的段落。');\n            return null;\n        }\n\n        setIsFilteringChunks(true);\n        setFilterError(null);\n\n        try {\n            const existingScores = (chunkScores.length === chunks.length) ? chunkScores : null;\n            const computedScores = existingScores || (await scoreChunks(chunks, title)) || [];\n\n            if (!computedScores.length) {\n                setFilterError('無法取得語意距離，請確認標題與 API 設定。');\n                return null;\n            }\n\n            const keptChunks = chunks.filter((chunk, idx) => {\n                const similarity = computedScores[idx] ?? 1;\n                const forcedKeep = manualKeep[idx];\n                return forcedKeep || similarity >= semanticThreshold;\n            });\n\n            const filteredContent = keptChunks.join('\\n\\n').trim();\n            setIsChunkModalOpen(false);\n            return filteredContent;\n        } catch (error: any) {\n            setFilterError(error?.message || '語意過濾失敗，請稍後再試。');\n            return null;\n        } finally {\n            setIsFilteringChunks(false);\n        }\n    }, [chunkPreview, chunkScores, manualKeep, scoreChunks, semanticThreshold]);\n\n    return {\n        isChunkModalOpen,\n        setIsChunkModalOpen,\n        chunkPreview,\n        chunkScores,\n        isScoringChunks,\n        isFilteringChunks,\n        filterError,\n        manualKeep,\n        setManualKeep,\n        openFilterModal,\n        applyFilter,\n        semanticThreshold,\n        semanticThresholdInput,\n        setSemanticThresholdInput,\n        commitSemanticThreshold,\n        DEFAULT_SEMANTIC_THRESHOLD\n    };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1174, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useImageEditor.ts"],"sourcesContent":["import { useCallback, useState } from 'react';\nimport { TargetAudience, CostBreakdown, TokenUsage, ScrapedImage, ImageAssetPlan } from '../types';\nimport { generateImagePromptFromContext, generateImage, planImagesForArticle } from '../services/generation/imageService';\n\ninterface UseImageEditorParams {\n    editorRef: React.RefObject<HTMLDivElement>;\n    tiptapApi?: {\n        insertImage: (src: string, alt?: string) => void;\n        getPlainText?: () => string;\n        getHtml?: () => string;\n        setHtml?: (html: string) => void;\n    };\n    imageContainerRef?: React.RefObject<HTMLElement>;\n    targetAudience: TargetAudience;\n    visualStyle?: string;\n    scrapedImages: ScrapedImage[];\n    onAddCost?: (cost: CostBreakdown, usage: TokenUsage) => void;\n    handleInput: (e: React.FormEvent<HTMLDivElement>) => void;\n    saveSelection: () => Range | null;\n    restoreSelection: () => void;\n}\n\nexport const useImageEditor = ({\n    editorRef,\n    tiptapApi,\n    imageContainerRef,\n    targetAudience,\n    visualStyle,\n    scrapedImages,\n    onAddCost,\n    handleInput,\n    saveSelection,\n    restoreSelection,\n}: UseImageEditorParams) => {\n    const [showImageModal, setShowImageModal] = useState(false);\n    const [imagePrompt, setImagePrompt] = useState('');\n    const [isImageLoading, setIsImageLoading] = useState(false);\n    const [isDownloadingImages, setIsDownloadingImages] = useState(false);\n    const [imagePlans, setImagePlans] = useState<ImageAssetPlan[]>([]);\n    const [isPlanning, setIsPlanning] = useState(false);\n    const [isBatchProcessing, setIsBatchProcessing] = useState(false);\n\n    const openImageModal = useCallback(async () => {\n        saveSelection();\n        setShowImageModal(true);\n        setIsImageLoading(true);\n        setImagePrompt('Analyzing context...');\n\n        let contextText = '';\n        if (tiptapApi?.getPlainText) {\n            const text = tiptapApi.getPlainText();\n            contextText = text.substring(0, 200);\n        } else if (editorRef.current) {\n            const fullText = editorRef.current.innerText;\n            const selection = window.getSelection();\n            if (selection && selection.rangeCount > 0) {\n                const range = selection.getRangeAt(0);\n                const preCaretRange = range.cloneRange();\n                preCaretRange.selectNodeContents(editorRef.current);\n                preCaretRange.setEnd(range.startContainer, range.startOffset);\n                const startOffset = preCaretRange.toString().length;\n                const start = Math.max(0, startOffset - 100);\n                const end = Math.min(fullText.length, startOffset + 100);\n                contextText = fullText.substring(start, end);\n            } else {\n                contextText = fullText.substring(0, 200);\n            }\n        }\n\n        try {\n            const res = await generateImagePromptFromContext(contextText, targetAudience, visualStyle || '');\n            setImagePrompt(res.data);\n            onAddCost?.(res.cost, res.usage);\n        } catch (e) {\n            setImagePrompt('Create a realistic image relevant to this article.');\n        } finally {\n            setIsImageLoading(false);\n        }\n    }, [editorRef, onAddCost, saveSelection, targetAudience, visualStyle]);\n\n    const generateImageFromPrompt = useCallback(async (prompt: string) => {\n        if (!prompt) return;\n        setIsImageLoading(true);\n        try {\n            const res = await generateImage(prompt);\n            if (res.data) {\n                const imgHtml = `<img src=\"${res.data}\" alt=\"${prompt}\" style=\"max-width: 100%; height: auto; border-radius: 8px; margin: 20px 0;\" /><br/>`;\n                if (tiptapApi) {\n                    tiptapApi.insertImage(res.data, prompt);\n                } else {\n                    restoreSelection();\n                    document.execCommand('insertHTML', false, imgHtml);\n                    if (editorRef.current) handleInput({ currentTarget: editorRef.current } as React.FormEvent<HTMLDivElement>);\n                }\n                onAddCost?.(res.cost, res.usage);\n                setShowImageModal(false);\n            } else {\n                alert('Image generation returned no data.');\n            }\n        } catch (e) {\n            console.error('Image generation error', e);\n            alert('Failed to generate image.');\n        } finally {\n            setIsImageLoading(false);\n        }\n    }, [editorRef, handleInput, onAddCost, restoreSelection]);\n\n    const downloadImages = useCallback(async () => {\n        const container = imageContainerRef?.current || editorRef.current || document.body;\n        const images = container.querySelectorAll('img');\n        if (images.length === 0) {\n            alert('No images found in the editor to download.');\n            return;\n        }\n        if (!confirm(`Found ${images.length} images in the article. Download them now?`)) return;\n\n        setIsDownloadingImages(true);\n        const downloadLink = document.createElement('a');\n        downloadLink.style.display = 'none';\n        document.body.appendChild(downloadLink);\n\n        try {\n            for (let i = 0; i < images.length; i++) {\n                const img = images[i] as HTMLImageElement;\n                const src = img.src;\n                const ext = src.includes('image/jpeg') ? 'jpg' : 'png';\n                const filename = `article-image-${Date.now()}-${i + 1}.${ext}`;\n\n                if (src.startsWith('data:')) {\n                    downloadLink.href = src;\n                    downloadLink.download = filename;\n                    downloadLink.click();\n                } else {\n                    try {\n                        const response = await fetch(src);\n                        const blob = await response.blob();\n                        const url = URL.createObjectURL(blob);\n                        downloadLink.href = url;\n                        downloadLink.download = filename;\n                        downloadLink.click();\n                        URL.revokeObjectURL(url);\n                    } catch (err) {\n                        console.warn(`Failed to download ${src}, opening in new tab instead.`);\n                        window.open(src, '_blank');\n                    }\n                }\n                await new Promise((r) => setTimeout(r, 200));\n            }\n        } catch (e) {\n            console.error('Download failed', e);\n            alert('Some images could not be downloaded.');\n        } finally {\n            document.body.removeChild(downloadLink);\n            setIsDownloadingImages(false);\n        }\n    }, [editorRef]);\n\n    const updatePlanPrompt = useCallback((id: string, newPrompt: string) => {\n        setImagePlans((prev) => prev.map((p) => (p.id === id ? { ...p, generatedPrompt: newPrompt } : p)));\n    }, []);\n\n    const injectImageIntoEditor = useCallback((plan: ImageAssetPlan, method: 'auto' | 'cursor' = 'auto') => {\n        if (!plan.url) return;\n\n        const imgHtml = `<img src=\"${plan.url}\" alt=\"${plan.generatedPrompt}\" style=\"max-width: 100%; height: auto; border-radius: 8px; margin: 24px 0; display: block; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);\" />`;\n        const anchorText = plan.insertAfter?.trim() || '';\n        const tryInjectByAnchor = (html: string, replaceFn: (nextHtml: string) => void) => {\n            const insertAt = (target: string) => {\n                if (!target || !html.includes(target)) return false;\n                replaceFn(html.replace(target, `${target}<br/>${imgHtml}`));\n                return true;\n            };\n\n            if (insertAt(anchorText)) return true;\n\n            const chunks = anchorText\n                .split(/[，,。.\\n\\t\\s、：:]+/)\n                .filter((c) => c.length >= 4)\n                .sort((a, b) => b.length - a.length);\n\n            for (const chunk of chunks) {\n                if (insertAt(chunk)) return true;\n            }\n            return false;\n        };\n\n        if (tiptapApi) {\n            const insertAtSelection = () => tiptapApi.insertImage(plan.url!, plan.generatedPrompt);\n\n            if (method === 'cursor' || !anchorText || !tiptapApi.getHtml || !tiptapApi.setHtml) {\n                insertAtSelection();\n                return;\n            }\n\n            const html = tiptapApi.getHtml();\n            const injected = tryInjectByAnchor(html, (nextHtml) => tiptapApi.setHtml!(nextHtml));\n            if (!injected) {\n                insertAtSelection();\n            }\n            return;\n        }\n\n        if (!editorRef.current) return;\n\n        if (method === 'cursor') {\n            restoreSelection();\n            document.execCommand('insertHTML', false, imgHtml);\n            handleInput({ currentTarget: editorRef.current } as React.FormEvent<HTMLDivElement>);\n            return;\n        }\n\n        const currentHtml = editorRef.current.innerHTML;\n        const injected = tryInjectByAnchor(currentHtml, (nextHtml) => {\n            editorRef.current!.innerHTML = nextHtml;\n            handleInput({ currentTarget: editorRef.current! } as React.FormEvent<HTMLDivElement>);\n        });\n\n        if (!injected) {\n            alert(`Could not find anchor: \"...${anchorText.substring(0, 15)}...\". \\n\\nPlease place your cursor in the text and click the \"Cursor\" button to insert manually.`);\n        }\n    }, [editorRef, handleInput, restoreSelection, tiptapApi]);\n\n    const generateSinglePlan = useCallback(async (plan: ImageAssetPlan) => {\n        if (plan.status === 'generating') return;\n        setImagePlans((prev) => prev.map((p) => (p.id === plan.id ? { ...p, status: 'generating' } : p)));\n        try {\n            const imgRes = await generateImage(plan.generatedPrompt);\n            if (imgRes.data) {\n                const updatedPlan = { ...plan, status: 'done' as const, url: imgRes.data || undefined };\n                setImagePlans((prev) => prev.map((p) => (p.id === plan.id ? updatedPlan : p)));\n                onAddCost?.(imgRes.cost, imgRes.usage);\n            } else {\n                setImagePlans((prev) => prev.map((p) => (p.id === plan.id ? { ...p, status: 'error' } : p)));\n            }\n        } catch (e) {\n            console.error('Single generation failed', e);\n            setImagePlans((prev) => prev.map((p) => (p.id === plan.id ? { ...p, status: 'error' } : p)));\n        }\n    }, [onAddCost]);\n\n    const handleBatchProcess = useCallback(async () => {\n        if (isBatchProcessing) return;\n        setIsBatchProcessing(true);\n        const plansToProcess = imagePlans.filter((p) => p.status !== 'done');\n        const promises = plansToProcess.map((plan) => generateSinglePlan(plan));\n        await Promise.all(promises);\n        setIsBatchProcessing(false);\n    }, [generateSinglePlan, imagePlans, isBatchProcessing]);\n\n    const autoPlanImages = useCallback(async () => {\n        const getContent = () => {\n            if (tiptapApi?.getPlainText) return tiptapApi.getPlainText();\n            return editorRef.current?.innerText || '';\n        };\n        if (isPlanning) return;\n        setIsPlanning(true);\n        try {\n            const content = getContent();\n            const res = await planImagesForArticle(content, scrapedImages, targetAudience, visualStyle || '');\n            setImagePlans(res.data);\n            onAddCost?.(res.cost, res.usage);\n        } catch (e) {\n            console.error('Auto-plan failed', e);\n            alert('Failed to plan images.');\n        } finally {\n            setIsPlanning(false);\n        }\n    }, [editorRef, onAddCost, scrapedImages, targetAudience, visualStyle, isPlanning]);\n\n    return {\n        showImageModal,\n        setShowImageModal,\n        imagePrompt,\n        setImagePrompt,\n        isImageLoading,\n        isDownloadingImages,\n        imagePlans,\n        isPlanning,\n        isBatchProcessing,\n        openImageModal,\n        generateImageFromPrompt,\n        downloadImages,\n        autoPlanImages,\n        updatePlanPrompt,\n        injectImageIntoEditor,\n        generateSinglePlan,\n        handleBatchProcess,\n    };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1467, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useMetaGenerator.ts"],"sourcesContent":["import { useCallback, useState } from 'react';\nimport { generateSnippet } from '../services/generation/contentGenerationService';\nimport { TargetAudience, CostBreakdown, TokenUsage, ProductBrief } from '../types';\nimport { promptTemplates } from '../services/engine/promptTemplates';\nimport { Type } from '../services/engine/schemaTypes';\nimport { aiService } from '../services/engine/aiService';\n\ninterface MetaContext {\n    keyPoints: string[];\n    brandExclusivePoints: string[];\n    productBrief?: ProductBrief | null;\n    visualStyle?: string;\n    outlineSections?: string[];\n}\n\ninterface UseMetaGeneratorParams {\n    editorRef: React.RefObject<HTMLDivElement>;\n    tiptapApi?: { getPlainText: () => string } | null;\n    targetAudience: TargetAudience;\n    context: MetaContext;\n    onAddCost?: (cost: CostBreakdown, usage: TokenUsage) => void;\n    onMetaGenerated?: (meta: { title: string; description: string; slug: string }) => void;\n}\n\nexport const useMetaGenerator = ({\n    editorRef,\n    tiptapApi,\n    targetAudience,\n    context,\n    onAddCost,\n    onMetaGenerated,\n}: UseMetaGeneratorParams) => {\n    const [metaTitle, setMetaTitle] = useState('');\n    const [metaDescription, setMetaDescription] = useState('');\n    const [urlSlug, setUrlSlug] = useState('');\n    const [isMetaLoading, setIsMetaLoading] = useState(false);\n\n    const generateMeta = useCallback(async () => {\n        setIsMetaLoading(true);\n        try {\n            const articleText = (tiptapApi?.getPlainText ? tiptapApi.getPlainText() : editorRef.current?.innerText || '').slice(0, 1000);\n            const contextLines: string[] = [];\n            if (context.keyPoints.length > 0) contextLines.push(`Key Points: ${context.keyPoints.slice(0, 6).join('; ')} `);\n            if (context.brandExclusivePoints.length > 0) contextLines.push(`Brand USPs: ${context.brandExclusivePoints.slice(0, 4).join('; ')} `);\n            if (context.productBrief?.brandName || context.productBrief?.productName) {\n                contextLines.push(`Brand: ${context.productBrief?.brandName || ''} Product: ${context.productBrief?.productName || ''} USP: ${context.productBrief?.usp || ''} `);\n            }\n            if (context.visualStyle) contextLines.push(`Visual Style: ${context.visualStyle} `);\n            if (context.outlineSections && context.outlineSections.length > 0) {\n                const outlinePreview = context.outlineSections.slice(0, 8).join(' > ');\n                contextLines.push(`Outline: ${outlinePreview} `);\n            }\n\n            const metaPrompt = promptTemplates.metaSeo({\n                targetAudience,\n                contextLines,\n                articlePreview: articleText,\n            });\n\n            const res = await generateSnippet(metaPrompt, targetAudience, {\n                responseMimeType: 'application/json',\n                responseSchema: {\n                    type: Type.OBJECT,\n                    properties: {\n                        title: { type: Type.STRING },\n                        description: { type: Type.STRING },\n                        slug: { type: Type.STRING }\n                    }\n                },\n                // Force JSON and minimal verbosity\n                generationConfig: {\n                    response_mime_type: 'application/json'\n                }\n            });\n\n            const parsed = JSON.parse(res.data || '{}');\n            const title = parsed.title || metaTitle || '';\n            const description = parsed.description || metaDescription || '';\n            const slug = parsed.slug || metaTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') || '';\n            setMetaTitle(title);\n            setMetaDescription(description);\n            setUrlSlug(slug);\n            onMetaGenerated?.({ title, description, slug });\n            onAddCost?.(res.cost, res.usage);\n        } catch (err) {\n            console.error('Meta generation failed', err);\n            alert('Failed to generate meta info. Please try again.');\n        } finally {\n            setIsMetaLoading(false);\n        }\n    }, [\n        context.brandExclusivePoints,\n        context.keyPoints,\n        context.productBrief,\n        context.visualStyle,\n        context.outlineSections,\n        editorRef,\n        onAddCost,\n        onMetaGenerated,\n        targetAudience\n    ]);\n\n    return {\n        metaTitle,\n        metaDescription,\n        urlSlug,\n        setMetaTitle,\n        setMetaDescription,\n        setUrlSlug,\n        isMetaLoading,\n        generateMeta,\n    };\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AAEA;AACA;;;;;AAoBO,MAAM,mBAAmB,CAAC,EAC7B,SAAS,EACT,SAAS,EACT,cAAc,EACd,OAAO,EACP,SAAS,EACT,eAAe,EACM;IACrB,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAAC;IAC3C,MAAM,CAAC,iBAAiB,mBAAmB,GAAG,IAAA,iNAAQ,EAAC;IACvD,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAC;IACvC,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,iNAAQ,EAAC;IAEnD,MAAM,eAAe,IAAA,oNAAW,EAAC;QAC7B,iBAAiB;QACjB,IAAI;YACA,MAAM,cAAc,CAAC,WAAW,eAAe,UAAU,YAAY,KAAK,UAAU,OAAO,EAAE,aAAa,EAAE,EAAE,KAAK,CAAC,GAAG;YACvH,MAAM,eAAyB,EAAE;YACjC,IAAI,QAAQ,SAAS,CAAC,MAAM,GAAG,GAAG,aAAa,IAAI,CAAC,CAAC,YAAY,EAAE,QAAQ,SAAS,CAAC,KAAK,CAAC,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC;YAC9G,IAAI,QAAQ,oBAAoB,CAAC,MAAM,GAAG,GAAG,aAAa,IAAI,CAAC,CAAC,YAAY,EAAE,QAAQ,oBAAoB,CAAC,KAAK,CAAC,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC;YACpI,IAAI,QAAQ,YAAY,EAAE,aAAa,QAAQ,YAAY,EAAE,aAAa;gBACtE,aAAa,IAAI,CAAC,CAAC,OAAO,EAAE,QAAQ,YAAY,EAAE,aAAa,GAAG,UAAU,EAAE,QAAQ,YAAY,EAAE,eAAe,GAAG,MAAM,EAAE,QAAQ,YAAY,EAAE,OAAO,GAAG,CAAC,CAAC;YACpK;YACA,IAAI,QAAQ,WAAW,EAAE,aAAa,IAAI,CAAC,CAAC,cAAc,EAAE,QAAQ,WAAW,CAAC,CAAC,CAAC;YAClF,IAAI,QAAQ,eAAe,IAAI,QAAQ,eAAe,CAAC,MAAM,GAAG,GAAG;gBAC/D,MAAM,iBAAiB,QAAQ,eAAe,CAAC,KAAK,CAAC,GAAG,GAAG,IAAI,CAAC;gBAChE,aAAa,IAAI,CAAC,CAAC,SAAS,EAAE,eAAe,CAAC,CAAC;YACnD;YAEA,MAAM,aAAa,+JAAe,CAAC,OAAO,CAAC;gBACvC;gBACA;gBACA,gBAAgB;YACpB;YAEA,MAAM,MAAM,MAAM,IAAA,4KAAe,EAAC,YAAY,gBAAgB;gBAC1D,kBAAkB;gBAClB,gBAAgB;oBACZ,MAAM,gJAAI,CAAC,MAAM;oBACjB,YAAY;wBACR,OAAO;4BAAE,MAAM,gJAAI,CAAC,MAAM;wBAAC;wBAC3B,aAAa;4BAAE,MAAM,gJAAI,CAAC,MAAM;wBAAC;wBACjC,MAAM;4BAAE,MAAM,gJAAI,CAAC,MAAM;wBAAC;oBAC9B;gBACJ;gBACA,mCAAmC;gBACnC,kBAAkB;oBACd,oBAAoB;gBACxB;YACJ;YAEA,MAAM,SAAS,KAAK,KAAK,CAAC,IAAI,IAAI,IAAI;YACtC,MAAM,QAAQ,OAAO,KAAK,IAAI,aAAa;YAC3C,MAAM,cAAc,OAAO,WAAW,IAAI,mBAAmB;YAC7D,MAAM,OAAO,OAAO,IAAI,IAAI,UAAU,WAAW,GAAG,OAAO,CAAC,eAAe,KAAK,OAAO,CAAC,YAAY,OAAO;YAC3G,aAAa;YACb,mBAAmB;YACnB,WAAW;YACX,kBAAkB;gBAAE;gBAAO;gBAAa;YAAK;YAC7C,YAAY,IAAI,IAAI,EAAE,IAAI,KAAK;QACnC,EAAE,OAAO,KAAK;YACV,QAAQ,KAAK,CAAC,0BAA0B;YACxC,MAAM;QACV,SAAU;YACN,iBAAiB;QACrB;IACJ,GAAG;QACC,QAAQ,oBAAoB;QAC5B,QAAQ,SAAS;QACjB,QAAQ,YAAY;QACpB,QAAQ,WAAW;QACnB,QAAQ,eAAe;QACvB;QACA;QACA;QACA;KACH;IAED,OAAO;QACH;QACA;QACA;QACA;QACA;QACA;QACA;QACA;IACJ;AACJ"}},
    {"offset": {"line": 1570, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useAskAi.ts"],"sourcesContent":["import { useCallback, useRef } from 'react';\nimport { marked } from 'marked';\nimport { generateSnippet } from '../services/generation/contentGenerationService';\nimport { getLanguageInstruction } from '../services/engine/promptService';\nimport type { AskAiRunActionInput } from '../components/AskAiSelection';\nimport { TargetAudience, CostBreakdown, TokenUsage } from '../types';\n\ntype AskAiMode = 'edit' | 'format';\n\ntype TiptapApi = {\n    getSelectedText: () => string;\n    insertHtml: (html: string) => void;\n    getPlainText: () => string;\n    getHtml: () => string;\n    setHtml: (html: string) => void;\n    getSelectionRange: () => { from: number; to: number };\n    replaceRange: (range: { from: number; to: number }, html: string) => void;\n    markAskAiRange: (range: { from: number; to: number }, taskId: string) => void;\n    clearAskAiMarks: (taskId?: string) => void;\n    findAskAiRange: (taskId: string) => { from: number; to: number } | null;\n    clearBold?: (options?: { removeBold?: boolean; removeBlockquotes?: boolean; removeQuotes?: boolean; target?: 'selection' | 'document' }) => boolean;\n    summarizeFormatting?: () => { boldMarks: number; blockquotes: number; quoteChars: number };\n};\n\ninterface UseAskAiParams {\n    tiptapApi: TiptapApi | null;\n    targetAudience: TargetAudience;\n    onAddCost?: (cost: CostBreakdown, usage: TokenUsage) => void;\n    setIsAiLoading: (loading: boolean) => void;\n    updateCountsFromText: (text: string) => void;\n    onChange?: (html: string) => void;\n}\n\nexport const useAskAi = ({\n    tiptapApi,\n    targetAudience,\n    onAddCost,\n    setIsAiLoading,\n    updateCountsFromText,\n    onChange,\n}: UseAskAiParams) => {\n    const askAiRangesRef = useRef<Record<string, { from: number; to: number }>>({});\n    const lastRangeRef = useRef<{ from: number; to: number } | null>(null);\n    const lastActionModeRef = useRef<AskAiMode | null>(null);\n    const pendingCountRef = useRef(0);\n\n    const clearAskAiState = useCallback(() => {\n        // Keep other task highlights; only clear generic marks if no task is specified.\n        lastActionModeRef.current = null;\n    }, [tiptapApi]);\n\n    const buildAskAiPrompt = useCallback((input: AskAiRunActionInput, text: string) => {\n        const languageInstruction = getLanguageInstruction(targetAudience);\n\n        if (input.mode === 'format') {\n            let task = '';\n            switch (input.preset) {\n                case 'bullet':\n                    task = 'Convert to a bullet list.';\n                    break;\n                case 'ordered':\n                    task = 'Convert to an ordered (numbered) list.';\n                    break;\n                case 'table-2':\n                    task = 'Present as a 2-column table (Header + Row values).';\n                    break;\n                case 'table-3':\n                    task = 'Present as a 3-column table (Header + Row values).';\n                    break;\n                case 'checklist':\n                    task = 'Convert to a checklist with unchecked boxes.';\n                    break;\n                case 'quote':\n                    task = 'Wrap as a highlighted quote block.';\n                    break;\n                case 'markdown-clean':\n                    task = 'Clean up Markdown/HTML, fix nesting, and keep structure minimal.';\n                    break;\n                default:\n                    task = 'Reformat cleanly.';\n            }\n            return `TARGET CONTENT: \"\"\"${text}\"\"\"\\nTASK: ${task} Return ONLY the formatted HTML/Markdown.\\n\\n${languageInstruction}`;\n        }\n\n        const presetInstruction = (() => {\n            switch (input.preset) {\n                case 'rephrase':\n                    return 'Rephrase for clarity while keeping meaning. Ensure the tone is natural and professional.';\n                case 'shorten':\n                    return 'CRITICAL: Condense the text by 30-50%. Remove all fluff, redundancy, and filler words. Keep ONLY the core message.';\n                case 'elaborate':\n                    return 'Expand with 1-2 concise sentences to add clarity.';\n                case 'formal':\n                    return 'Rewrite in a more formal tone.';\n                case 'casual':\n                    return 'Rewrite in a friendlier, more casual tone.';\n                case 'bulletise':\n                    return 'Convert into concise bullet points.';\n                case 'summarise':\n                    return 'Summarise into a brief paragraph or 2 bullets.';\n                default:\n                    return input.prompt || 'Improve the text with better flow.';\n            }\n        })();\n\n        return `TARGET TEXT: \"\"\"${text}\"\"\"\\nINSTRUCTION: ${presetInstruction}${input.prompt ? `\\nCUSTOM PROMPT: ${input.prompt}` : ''}\\n\\n${languageInstruction}\\n\\nTASK: Return ONLY the rewritten result in HTML/Markdown.`;\n    }, [targetAudience]);\n\n    const lockAskAiRange = useCallback((taskId?: string) => {\n        if (!tiptapApi) return null;\n        const selectionRange = tiptapApi.getSelectionRange?.() || null;\n        if (selectionRange) {\n            lastRangeRef.current = selectionRange;\n            if (taskId) {\n                askAiRangesRef.current[taskId] = selectionRange;\n                tiptapApi.markAskAiRange?.(selectionRange, taskId);\n            }\n        }\n        return selectionRange;\n    }, [tiptapApi]);\n\n    const runAskAiAction = useCallback(async (input: AskAiRunActionInput) => {\n        if (!tiptapApi) {\n            alert('Editor not ready.');\n            throw new Error('Editor not ready');\n        }\n        const selectionRange =\n            (input.taskId ? tiptapApi.findAskAiRange?.(input.taskId) : null) ||\n            (input.taskId ? askAiRangesRef.current[input.taskId] : null) ||\n            lastRangeRef.current ||\n            tiptapApi.getSelectionRange?.() ||\n            null;\n        lastActionModeRef.current = input.mode;\n        if (selectionRange) {\n            lastRangeRef.current = selectionRange;\n            if (input.taskId) {\n                askAiRangesRef.current[input.taskId] = selectionRange;\n            }\n        }\n        const selectedText = (input.selectedText || tiptapApi.getSelectedText?.() || '').trim();\n        if (!selectedText) {\n            alert('請先選取要調整的文字。');\n            throw new Error('No selection');\n        }\n        if (selectionRange && input.taskId) {\n            tiptapApi.markAskAiRange?.(selectionRange, input.taskId);\n        }\n        const promptToSend = buildAskAiPrompt(input, selectedText);\n\n        pendingCountRef.current += 1;\n        setIsAiLoading(true);\n        try {\n            const res = await generateSnippet(promptToSend, targetAudience as TargetAudience);\n            const htmlSnippet = marked.parse(res.data || '', { async: false }) as string;\n            onAddCost?.(res.cost, res.usage);\n            return htmlSnippet;\n        } catch (error) {\n            console.error(\"AI Edit failed\", error);\n            alert(\"Failed to generate content. Please try again.\");\n            throw error;\n        } finally {\n            pendingCountRef.current = Math.max(0, pendingCountRef.current - 1);\n            setIsAiLoading(pendingCountRef.current > 0);\n        }\n    }, [buildAskAiPrompt, onAddCost, setIsAiLoading, targetAudience, tiptapApi]);\n\n    const handleAskAiInsert = useCallback((html: string, taskId?: string) => {\n        if (!tiptapApi) return;\n        const selectionRange =\n            (taskId ? tiptapApi.findAskAiRange?.(taskId) : null) ||\n            (taskId ? askAiRangesRef.current[taskId] : null) ||\n            lastRangeRef.current ||\n            tiptapApi.getSelectionRange?.();\n        const mode = lastActionModeRef.current;\n        if (selectionRange) {\n            tiptapApi.replaceRange(selectionRange, html);\n        } else {\n            tiptapApi.insertHtml(html);\n        }\n        if (taskId) {\n            delete askAiRangesRef.current[taskId];\n            tiptapApi.clearAskAiMarks?.(taskId);\n        }\n        clearAskAiState();\n        const updatedText = tiptapApi.getPlainText();\n        updateCountsFromText(updatedText);\n        onChange?.(tiptapApi.getHtml());\n    }, [clearAskAiState, onChange, tiptapApi, updateCountsFromText]);\n\n    return {\n        runAskAiAction,\n        handleAskAiInsert,\n        clearAskAiState,\n        lockAskAiRange,\n        highlightAskAiTarget: (taskId: string) => {\n            const range = tiptapApi?.findAskAiRange?.(taskId);\n            if (range) {\n                tiptapApi?.markAskAiRange?.(range, taskId);\n            }\n        },\n    };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1748, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useEditorAutosave.ts"],"sourcesContent":["import { useCallback, useEffect, useRef } from 'react';\n\ntype MetaState = {\n    metaTitle?: string;\n    metaDescription?: string;\n    urlSlug?: string;\n    articleTitle?: string;\n};\n\ninterface UseEditorAutosaveParams {\n    storageKey?: string;\n    debounceMs?: number;\n}\n\nexport const useEditorAutosave = ({\n    storageKey = 'ai_writer_editor_autosave_v1',\n    debounceMs = 3000\n}: UseEditorAutosaveParams) => {\n    const autosaveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n    const latestHtmlRef = useRef<string>('');\n    const latestMetaRef = useRef<MetaState>({});\n    const pendingRestoreRef = useRef<any | null>(null);\n    const lastSavedRef = useRef<string>(''); // cache serialized payload to avoid redundant writes\n\n    // Load saved draft on mount\n    useEffect(() => {\n        if (typeof window === 'undefined') return;\n        try {\n            const savedRaw = localStorage.getItem(storageKey);\n            if (!savedRaw) return;\n            const saved = JSON.parse(savedRaw);\n            if (saved && saved.html) {\n                pendingRestoreRef.current = saved;\n            }\n        } catch (e) {\n            console.warn('Failed to read autosave', e);\n        }\n    }, [storageKey]);\n\n    const queueAutosave = useCallback(() => {\n        if (typeof window === 'undefined') return;\n        if (autosaveTimerRef.current) clearTimeout(autosaveTimerRef.current);\n        autosaveTimerRef.current = setTimeout(() => {\n            const payload = {\n                html: latestHtmlRef.current || '',\n                ...latestMetaRef.current,\n                ts: Date.now(),\n            };\n            if (!payload.html.trim()) return;\n            const serialized = JSON.stringify(payload);\n            if (serialized === lastSavedRef.current) return;\n            try {\n                localStorage.setItem(storageKey, serialized);\n                lastSavedRef.current = serialized;\n            } catch (e) {\n                console.warn('Autosave failed', e);\n            }\n        }, debounceMs);\n    }, [debounceMs, storageKey]);\n\n    const recordHtml = useCallback((html: string) => {\n        latestHtmlRef.current = html || '';\n        queueAutosave();\n    }, [queueAutosave]);\n\n    const recordMeta = useCallback((meta: MetaState) => {\n        latestMetaRef.current = { ...latestMetaRef.current, ...meta };\n        queueAutosave();\n    }, [queueAutosave]);\n\n    const consumeDraft = useCallback(() => {\n        const saved = pendingRestoreRef.current;\n        pendingRestoreRef.current = null;\n        return saved as (MetaState & { html: string }) | null;\n    }, []);\n\n    return { recordHtml, recordMeta, consumeDraft };\n};\n"],"names":[],"mappings":";;;;AAAA;;AAcO,MAAM,oBAAoB,CAAC,EAC9B,aAAa,8BAA8B,EAC3C,aAAa,IAAI,EACK;IACtB,MAAM,mBAAmB,IAAA,+MAAM,EAAuC;IACtE,MAAM,gBAAgB,IAAA,+MAAM,EAAS;IACrC,MAAM,gBAAgB,IAAA,+MAAM,EAAY,CAAC;IACzC,MAAM,oBAAoB,IAAA,+MAAM,EAAa;IAC7C,MAAM,eAAe,IAAA,+MAAM,EAAS,KAAK,qDAAqD;IAE9F,4BAA4B;IAC5B,IAAA,kNAAS,EAAC;QACN,wCAAmC;;;IAWvC,GAAG;QAAC;KAAW;IAEf,MAAM,gBAAgB,IAAA,oNAAW,EAAC;QAC9B,wCAAmC;;;IAkBvC,GAAG;QAAC;QAAY;KAAW;IAE3B,MAAM,aAAa,IAAA,oNAAW,EAAC,CAAC;QAC5B,cAAc,OAAO,GAAG,QAAQ;QAChC;IACJ,GAAG;QAAC;KAAc;IAElB,MAAM,aAAa,IAAA,oNAAW,EAAC,CAAC;QAC5B,cAAc,OAAO,GAAG;YAAE,GAAG,cAAc,OAAO;YAAE,GAAG,IAAI;QAAC;QAC5D;IACJ,GAAG;QAAC;KAAc;IAElB,MAAM,eAAe,IAAA,oNAAW,EAAC;QAC7B,MAAM,QAAQ,kBAAkB,OAAO;QACvC,kBAAkB,OAAO,GAAG;QAC5B,OAAO;IACX,GAAG,EAAE;IAEL,OAAO;QAAE;QAAY;QAAY;IAAa;AAClD"}},
    {"offset": {"line": 1806, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/generation/generationLogger.ts"],"sourcesContent":["import { useGenerationStore } from '../../store/useGenerationStore';\n\nexport const appendAnalysisLog = (msg: string) => {\n    const store = useGenerationStore.getState();\n    // Only append logs to content during the analysis phase\n    if (store.status === 'analyzing') {\n        // store.setContent(prev => {\n        //     const next = typeof prev === 'string' ? prev : '';\n        //     return next ? `${next}\\n${msg}` : msg;\n        // });\n        console.log(`[Analysis Log]: ${msg}`);\n    } else {\n        console.log(`[Background Log]: ${msg}`);\n    }\n};\n\nexport const summarizeList = (items: string[], max: number = 5) => {\n    const slice = items.slice(0, max);\n    const more = items.length > max ? ` +${items.length - max}` : '';\n    return slice.join(', ') + more;\n};\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,MAAM,oBAAoB,CAAC;IAC9B,MAAM,QAAQ,wJAAkB,CAAC,QAAQ;IACzC,wDAAwD;IACxD,IAAI,MAAM,MAAM,KAAK,aAAa;QAC9B,6BAA6B;QAC7B,yDAAyD;QACzD,6CAA6C;QAC7C,MAAM;QACN,QAAQ,GAAG,CAAC,CAAC,gBAAgB,EAAE,KAAK;IACxC,OAAO;QACH,QAAQ,GAAG,CAAC,CAAC,kBAAkB,EAAE,KAAK;IAC1C;AACJ;AAEO,MAAM,gBAAgB,CAAC,OAAiB,MAAc,CAAC;IAC1D,MAAM,QAAQ,MAAM,KAAK,CAAC,GAAG;IAC7B,MAAM,OAAO,MAAM,MAAM,GAAG,MAAM,CAAC,EAAE,EAAE,MAAM,MAAM,GAAG,KAAK,GAAG;IAC9D,OAAO,MAAM,IAAI,CAAC,QAAQ;AAC9B"}},
    {"offset": {"line": 1836, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/generation/useAnalysisPipeline.ts"],"sourcesContent":["import { ArticleConfig, SectionAnalysis } from '../../types';\nimport { useGenerationStore } from '../../store/useGenerationStore';\nimport { useAnalysisStore } from '../../store/useAnalysisStore';\nimport { useMetricsStore } from '../../store/useMetricsStore';\nimport { parseProductContext, generateProblemProductMapping } from '../../services/research/productFeatureToPainPointMapper';\nimport { analyzeText } from '../../services/engine/nlpService';\nimport { extractSemanticKeywordsAnalysis } from '../../services/research/termUsagePlanner';\nimport { SEMANTIC_KEYWORD_LIMIT } from '../../config/constants';\nimport { useSettingsStore } from '../../store/useSettingsStore';\nimport { analyzeReferenceStructure } from '../../services/research/referenceAnalysisService';\nimport { analyzeAuthorityTerms } from '../../services/research/authorityService';\nimport { analyzeImageWithAI, analyzeVisualStyle } from '../../services/generation/imageService';\nimport { appendAnalysisLog, summarizeList } from './generationLogger';\nimport { getLanguageInstruction } from '../../services/engine/promptService';\n\nimport { cleanHeadingText } from '../../utils/textUtils';\nimport { analyzeRegionalTerms } from '../../services/research/regionalAnalysisService';\n\n\nconst isStopped = () => useGenerationStore.getState().isStopped;\nconst audienceLabel = (aud: ArticleConfig['targetAudience']) => {\n    switch (aud) {\n        case 'zh-HK': return '繁體中文（香港）';\n        case 'zh-MY': return '簡體中文（馬來西亞）';\n        case 'zh-TW':\n        default:\n            return '繁體中文（台灣）';\n    }\n};\n\n\n\nexport const runAnalysisPipeline = async (config: ArticleConfig) => {\n    const generationStore = useGenerationStore.getState();\n    const analysisStore = useAnalysisStore.getState();\n    const metricsStore = useMetricsStore.getState();\n\n    // Reset State for Analysis\n    generationStore.setStatus('analyzing');\n    analysisStore.setScrapedImages(config.scrapedImages || []);\n    analysisStore.setTargetAudience(config.targetAudience);\n    analysisStore.setArticleTitle(config.title || '');\n    const languageInstruction = getLanguageInstruction(config.targetAudience);\n    analysisStore.setLanguageInstruction(languageInstruction);\n    console.info('[LangConfig]', { targetAudience: config.targetAudience, languageInstruction });\n    appendAnalysisLog(`語言設定：${audienceLabel(config.targetAudience)}（${config.targetAudience}）`);\n    appendAnalysisLog('Starting analysis...');\n\n    const fullConfig = {\n        ...config,\n        brandKnowledge: analysisStore.brandKnowledge\n    };\n\n    // Task 1: Product Context\n    const productTask = async () => {\n        let parsedProductBrief = config.productBrief;\n        let generatedMapping: any[] = [];\n\n        if (!parsedProductBrief && config.productRawText && config.productRawText.length > 5) {\n            if (isStopped()) return { mapping: [] };\n            generationStore.setGenerationStep('parsing_product');\n            appendAnalysisLog('Parsing product brief and CTA...');\n            const parseRes = await parseProductContext(config.productRawText);\n            console.log(`[Timer] Product Context Parse: ${parseRes.duration}ms`);\n            parsedProductBrief = parseRes.data;\n            appendAnalysisLog('Product brief parsed.');\n            metricsStore.addCost(parseRes.cost.totalCost, parseRes.usage.totalTokens);\n        }\n\n        if (parsedProductBrief && parsedProductBrief.productName) {\n            if (isStopped()) return { brief: parsedProductBrief, mapping: [] };\n            generationStore.setGenerationStep('mapping_product');\n            appendAnalysisLog('Mapping pain points to product features...');\n            const mapRes = await generateProblemProductMapping(parsedProductBrief, fullConfig.targetAudience);\n            console.log(`[Timer] Product Mapping: ${mapRes.duration}ms`);\n            generatedMapping = mapRes.data;\n            analysisStore.setProductMapping(generatedMapping);\n            if (generatedMapping.length > 0) {\n                const example = generatedMapping[0];\n                appendAnalysisLog(`Product-feature mapping ready (${generatedMapping.length}). e.g., ${example.painPoint} → ${example.productFeature}`);\n            } else {\n                appendAnalysisLog('Product-feature mapping ready (no matches found).');\n            }\n            metricsStore.addCost(mapRes.cost.totalCost, mapRes.usage.totalTokens);\n        }\n\n        analysisStore.setActiveProductBrief(parsedProductBrief);\n        return { brief: parsedProductBrief, mapping: generatedMapping };\n    };\n\n    // Task 1.5: Heading refinement for preview (uses extracted structure titles)\n\n\n    // Task 2: NLP & Keyword Planning\n    const keywordTask = async () => {\n        if (isStopped()) return;\n        generationStore.setGenerationStep('nlp_analysis');\n        appendAnalysisLog('Running NLP keyword scan...');\n        const keywords = await analyzeText(fullConfig.referenceContent);\n\n        // DYNAMIC LIMIT CALCULATION:\n        const settings = useSettingsStore.getState();\n        const contentLen = fullConfig.referenceContent.length;\n        const calculatedLimit = Math.floor(contentLen / settings.keywordCharDivisor);\n        const finalLimit = Math.max(settings.minKeywords, Math.min(settings.maxKeywords, calculatedLimit));\n\n        const keywordPlanCandidates = keywords.slice(0, finalLimit);\n        const topTokens = summarizeList(keywordPlanCandidates.map(k => k.token), 6);\n        appendAnalysisLog(`NLP scan found ${keywords.length} keywords. Using top ${keywordPlanCandidates.length} (Ratio: 1/${settings.keywordCharDivisor}, Min: ${settings.minKeywords}): ${topTokens}`);\n\n        if (keywordPlanCandidates.length > 0 && !isStopped()) {\n            generationStore.setGenerationStep('planning_keywords');\n            try {\n                appendAnalysisLog(`Planning keyword strategy (top ${keywordPlanCandidates.length})...`);\n                const planRes = await extractSemanticKeywordsAnalysis(fullConfig.referenceContent, keywords, fullConfig.targetAudience);\n                console.log(`[Timer] Keyword Action Plan: ${planRes.duration}ms`);\n                console.log(`[SemanticKeywords] Final aggregated plans: ${planRes.data.length} / ${keywordPlanCandidates.length}`);\n                analysisStore.setKeywordPlans(planRes.data);\n                const planWords = summarizeList(planRes.data.map(p => p.word), 6);\n                appendAnalysisLog(`Keyword plan ready (${planRes.data.length}). Focus: ${planWords}`);\n                metricsStore.addCost(planRes.cost.totalCost, planRes.usage.totalTokens);\n            } catch (e) {\n                console.warn(\"Action Plan extraction failed\", e);\n                appendAnalysisLog('Keyword planning failed (continuing).');\n            }\n        }\n    };\n\n    // Task 3: Structure & Authority (run concurrently)\n    const structureTask = async () => {\n        if (isStopped()) return;\n        generationStore.setGenerationStep('extracting_structure');\n        appendAnalysisLog('Extracting reference structure and authority signals...');\n        const [structRes, authRes] = await Promise.all([\n            analyzeReferenceStructure(fullConfig.referenceContent, fullConfig.targetAudience),\n            analyzeAuthorityTerms(\n                fullConfig.authorityTerms || '',\n                fullConfig.title,\n                fullConfig.websiteType || 'General Professional Website',\n                fullConfig.targetAudience\n            )\n        ]);\n\n        console.log(`[Timer] Narrative Structure (Outline): ${structRes.duration}ms`);\n        console.log(`[Timer] Authority Analysis: ${authRes.duration}ms`);\n        appendAnalysisLog(`Structure extracted (${structRes.data?.structure?.length || 0} sections).`);\n        appendAnalysisLog('Authority terms mapped.');\n        if (structRes.data?.structure?.length) {\n            const sectionTitles = summarizeList(structRes.data.structure.map((s: any) => s.title), 6);\n            appendAnalysisLog(`Sections: ${sectionTitles}`);\n        }\n        if (authRes.data?.relevantTerms?.length) {\n            appendAnalysisLog(`Authority terms: ${summarizeList(authRes.data.relevantTerms, 6)}`);\n        }\n\n        metricsStore.addCost(structRes.cost.totalCost, structRes.usage.totalTokens);\n        metricsStore.addCost(authRes.cost.totalCost, authRes.usage.totalTokens);\n\n        analysisStore.setRefAnalysis(structRes.data);\n        analysisStore.setAuthAnalysis(authRes.data);\n\n        return { structRes, authRes };\n    };\n\n    // Task 4: Image Analysis & Visual Style\n    const visualTask = async () => {\n        if (isStopped()) return;\n        generationStore.setGenerationStep('analyzing_visuals');\n        appendAnalysisLog('Analyzing source images and visual identity...');\n\n        const initialImages = config.scrapedImages || [];\n        const imagesToAnalyze = initialImages.slice(0, 5);\n        let analyzedImages = [...initialImages];\n\n        if (imagesToAnalyze.length > 0) {\n            for (let i = 0; i < imagesToAnalyze.length; i++) {\n                if (isStopped()) break;\n                const img = imagesToAnalyze[i];\n                if (img.url) {\n                    try {\n                        const res = await analyzeImageWithAI(img.url);\n                        analyzedImages[i] = { ...analyzedImages[i], aiDescription: res.data };\n                        metricsStore.addCost(res.cost.totalCost, res.usage.totalTokens);\n                    } catch (e) {\n                        console.warn(`Failed to analyze image ${img.url}`, e);\n                    }\n                }\n            }\n            analysisStore.setScrapedImages(analyzedImages);\n        }\n\n        try {\n            const styleRes = await analyzeVisualStyle(analyzedImages, fullConfig.websiteType || \"Modern Business\");\n            analysisStore.setVisualStyle(styleRes.data);\n            appendAnalysisLog(`✓ Visual style extracted: ${styleRes.data}`);\n            metricsStore.addCost(styleRes.cost.totalCost, styleRes.usage.totalTokens);\n        } catch (e) {\n            console.warn(\"Failed to extract visual style\", e);\n            appendAnalysisLog('Visual style extraction skipped.');\n        }\n    };\n\n\n\n    // Task 5: Regional Analysis (NEW)\n    const regionalTask = async () => {\n        if (isStopped()) return;\n        generationStore.setGenerationStep('localizing_hk'); // Reuse step label or create new 'analyzing_region'\n        appendAnalysisLog('Analyzing regional terminology & brand grounding...');\n\n        try {\n            const regionRes = await analyzeRegionalTerms(fullConfig.referenceContent, fullConfig.targetAudience);\n            console.log(`[Timer] Regional Analysis: ${regionRes.duration}ms`);\n\n            if (regionRes.data && regionRes.data.length > 0) {\n                appendAnalysisLog(`Regional analysis found ${regionRes.data.length} terms to correct.`);\n                // Store in refAnalysis (requires refAnalysis to be initialized first, or return it)\n                return regionRes.data;\n            } else {\n                appendAnalysisLog('Regional analysis: No major issues found.');\n                return [];\n            }\n        } catch (e) {\n            console.warn(\"Regional analysis failed\", e);\n            appendAnalysisLog('Regional analysis failed (continuing).');\n            return [];\n        }\n    };\n\n    // --- EXECUTE ALL TASKS WITH STAGGERING ---\n    // Burst protection: Start each major task 1 second apart to prevent proxy/backend overload\n    appendAnalysisLog('Dispatching analysis tasks with burst protection...');\n\n    const productResult = await productTask();\n    await new Promise(r => setTimeout(r, 1000));\n\n    const [structureResult, visualResultsPromise, regionalResult, keywordResult] = await Promise.all([\n        structureTask(),\n        (async () => {\n            await new Promise(r => setTimeout(r, 1000));\n            return visualTask();\n        })(),\n        (async () => {\n            await new Promise(r => setTimeout(r, 2000));\n            return regionalTask();\n        })(),\n        (async () => {\n            await new Promise(r => setTimeout(r, 3000));\n            return keywordTask();\n        })()\n    ]);\n\n    // Merge regional result into structureResult if available\n    if (structureResult?.structRes?.data) {\n        structureResult.structRes.data.regionalReplacements = regionalResult;\n        if (analysisStore.refAnalysis) {\n            analysisStore.setRefAnalysis({\n                ...analysisStore.refAnalysis,\n                regionalReplacements: regionalResult\n            });\n        }\n    }\n\n    appendAnalysisLog('All analysis tasks completed. Preparing to write...');\n    generationStore.setGenerationStep('idle');\n\n    return {\n        productResult,\n        structureResult,\n        keywordPromise: Promise.resolve(keywordResult),\n        visualPromise: Promise.resolve(visualResultsPromise),\n        regionalPromise: Promise.resolve(regionalResult)\n    };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2106, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/generation/useContentGenerator.ts"],"sourcesContent":["import { ArticleConfig, SectionAnalysis } from '../../types';\nimport { useGenerationStore } from '../../store/useGenerationStore';\nimport { useAnalysisStore } from '../../store/useAnalysisStore';\nimport { useMetricsStore } from '../../store/useMetricsStore';\nimport { generateSectionContent } from '../../services/generation/contentGenerationService';\nimport { mergeTurboSections } from '../../services/generation/contentDisplayService';\n\n\nimport { cleanHeadingText, stripLeadingHeading } from '../../utils/textUtils';\nimport { planImagesForArticle, generateImage } from '../../services/generation/imageService';\nimport { appendAnalysisLog } from './generationLogger';\nimport { aiService } from '../../services/engine/aiService';\n\nconst isStopped = () => useGenerationStore.getState().isStopped;\n\nexport const runContentGeneration = async (\n    config: ArticleConfig,\n    analysisResults: {\n        productResult: any;\n        structureResult: any;\n    }\n) => {\n    const generationStore = useGenerationStore.getState();\n    const analysisStore = useAnalysisStore.getState();\n    const metricsStore = useMetricsStore.getState();\n\n    const { productResult, structureResult } = analysisResults;\n    const parsedProductBrief = productResult?.brief;\n    const productMappingData = productResult?.mapping || [];\n    const refAnalysisData = structureResult?.structRes.data;\n    const authAnalysisData = structureResult?.authRes.data;\n\n    // 1. Determine Sections\n    let sectionsToGenerate: (Partial<SectionAnalysis> & { title: string; specificPlan?: string[] })[] = [];\n    let isUsingCustomOutline = false;\n\n    if (config.sampleOutline && config.sampleOutline.trim().length > 0) {\n        const lines = config.sampleOutline.split('\\n').map(line => line.trim()).filter(line => line.length > 0);\n        sectionsToGenerate = lines.map(title => ({ title }));\n        isUsingCustomOutline = true;\n    } else if (refAnalysisData?.structure && refAnalysisData.structure.length > 0) {\n        sectionsToGenerate = [...refAnalysisData.structure]; // Clone to avoid mutating original\n\n        // Inject Introduction if available\n        if (refAnalysisData.introText && refAnalysisData.introText.trim().length > 0) {\n            sectionsToGenerate.unshift({\n                title: \"前言\", // Use generic Intro title\n                narrativePlan: [refAnalysisData.introText],\n                subheadings: [],\n                difficulty: 'easy'\n            });\n        }\n        isUsingCustomOutline = false;\n    } else {\n        sectionsToGenerate = [\n            { title: \"Introduction\" },\n            { title: \"Core Concepts\" },\n            { title: \"Benefits\" },\n            { title: \"Applications\" },\n            { title: \"Conclusion\" }\n        ];\n    }\n\n    generationStore.setStatus('streaming');\n    generationStore.setGenerationStep('writing_content');\n    generationStore.setContent('');\n\n    const headingOptimizations = analysisStore.headingOptimizations || [];\n    const shouldUseHeadingAnalysis = !isUsingCustomOutline && headingOptimizations.length > 0;\n\n    const resolveHeadingFromOptimizer = (title: string): string => {\n        const normalizedTitle = cleanHeadingText(title);\n        if (!shouldUseHeadingAnalysis) return normalizedTitle;\n\n        const candidate = headingOptimizations.find(opt => {\n            const before = cleanHeadingText(opt.h2_before);\n            const after = cleanHeadingText(opt.h2_after);\n            return before === normalizedTitle || after === normalizedTitle;\n        });\n\n        if (!candidate) return normalizedTitle;\n\n        // Pick the highest scoring option from the optimizer; fallback to the suggested H2.\n        const scoredOptions = (candidate.h2_options || [])\n            .map(opt => ({\n                text: cleanHeadingText(opt.text || ''),\n                score: typeof opt.score === 'number' ? opt.score : undefined\n            }))\n            .filter(opt => opt.text && typeof opt.score === 'number')\n            .sort((a, b) => (b.score ?? -Infinity) - (a.score ?? -Infinity));\n\n        const fallback = cleanHeadingText(candidate.h2_after || candidate.h2_before || normalizedTitle);\n        return cleanHeadingText(scoredOptions[0]?.text || fallback || normalizedTitle);\n    };\n\n    const sectionBodies: string[] = new Array(sectionsToGenerate.length).fill(\"\");\n    const sectionHeadings: string[] = sectionsToGenerate.map((s) => resolveHeadingFromOptimizer(s.title));\n    const legacyKeyPoints = [\n        ...(Array.isArray(refAnalysisData?.keyInformationPoints) ? refAnalysisData.keyInformationPoints : []),\n        ...(Array.isArray(refAnalysisData?.brandExclusivePoints) ? refAnalysisData.brandExclusivePoints : [])\n    ];\n\n    const structuredKeyPoints = (refAnalysisData?.structure || []).flatMap((s: any) => [\n        ...(Array.isArray(s?.keyFacts) ? s.keyFacts : []),\n        ...(Array.isArray(s?.uspNotes) ? s.uspNotes : [])\n    ]).filter(Boolean);\n\n    const allKeyPoints = Array.from(new Set([...structuredKeyPoints, ...legacyKeyPoints])).filter(Boolean);\n\n    const generatorConfig = {\n        ...config,\n        productBrief: parsedProductBrief,\n        referenceAnalysis: refAnalysisData,\n        authorityAnalysis: authAnalysisData,\n    };\n\n    const shouldAutoPlanImages = Boolean(config.autoImagePlan);\n\n    const getHeading = (idx: number) => cleanHeadingText(sectionHeadings[idx] || sectionsToGenerate[idx]?.title || `Section ${idx + 1}`);\n\n    const renderSectionBlock = (idx: number, bodyOverride?: string) => {\n        const heading = getHeading(idx);\n        const body = typeof bodyOverride === 'string' ? bodyOverride : sectionBodies[idx];\n        if (body) return `## ${heading}\\n\\n${body}`;\n        return `## ${heading}\\n\\n_(Writing...)_`;\n    };\n\n    const renderTurboSections = () => mergeTurboSections(\n        sectionsToGenerate,\n        sectionBodies.map((body, idx) => body ? renderSectionBlock(idx, body) : \"\")\n    );\n\n    const renderProgressSections = () => sectionBodies\n        .map((_, idx) => renderSectionBlock(idx))\n        .join('\\n\\n');\n\n    const getKeywordPlans = () => useAnalysisStore.getState().keywordPlans || [];\n\n    const outlineSourceLabel = isUsingCustomOutline\n        ? `**User Custom Outline**`\n        : `**AI Narrative Structure (Outline)**`;\n\n    const initialDisplay = `> 📑 **Active Blueprint:** ${outlineSourceLabel}\\n\\n`;\n    generationStore.setContent(initialDisplay);\n\n    const promises = sectionsToGenerate.map(async (section, i) => {\n        if (isStopped()) return;\n\n        const allTitles = sectionsToGenerate.map(s => s.title);\n        const futureTitles = allTitles.slice(i + 1);\n        const analysisPlan = refAnalysisData?.structure.find((s: any) => s.title === section.title)?.narrativePlan;\n        const specificPlan = section.specificPlan || analysisPlan;\n        const sectionData = refAnalysisData?.structure.find((s: any) => s.title === section.title);\n        const sectionPoints = Array.from(new Set([\n            ...(Array.isArray(section.keyFacts) ? section.keyFacts : []),\n            ...(Array.isArray(section.uspNotes) ? section.uspNotes : []),\n            ...(Array.isArray(sectionData?.keyFacts) ? sectionData.keyFacts : []),\n            ...(Array.isArray(sectionData?.uspNotes) ? sectionData.uspNotes : []),\n            ...allKeyPoints\n        ])).filter(Boolean);\n\n        const loopConfig = { ...generatorConfig, productMapping: productMappingData };\n        const dummyPreviousContent = i > 0 ? [`[Preceding Section: ${allTitles[i - 1]}]`] : [];\n\n        try {\n            const res = await generateSectionContent(\n                loopConfig,\n                section.title,\n                specificPlan,\n                refAnalysisData?.generalPlan,\n                getKeywordPlans(),\n                dummyPreviousContent,\n                futureTitles,\n                authAnalysisData,\n                sectionPoints,\n                [],\n                0,\n                section\n            );\n\n            if (!isStopped()) {\n                sectionBodies[i] = stripLeadingHeading(res.data.content);\n                console.log(`[Timer - Turbo] Section '${section.title}': ${res.duration}ms`);\n\n                generationStore.setContent(renderTurboSections());\n                metricsStore.addCost(res.cost.totalCost, res.usage.totalTokens);\n\n                if (res.data.usedPoints && res.data.usedPoints.length > 0) {\n                    analysisStore.setCoveredPoints(prev => {\n                        const newUnique = res.data.usedPoints.filter(p => !prev.includes(p));\n                        return [...prev, ...newUnique];\n                    });\n                }\n            }\n        } catch (err) {\n            console.error(`Parallel gen error for ${section.title}`, err);\n            sectionBodies[i] = ''; // Suppress error message in content\n            generationStore.setContent(renderTurboSections());\n        }\n    });\n\n    await Promise.all(promises);\n\n    if (!isStopped()) {\n        generationStore.setContent(renderProgressSections());\n        // Auto-heading refinement disabled in favor of manual toolbar tool\n    }\n\n    if (!isStopped()) {\n        if (shouldAutoPlanImages) {\n            // --- IMAGE GENERATION PHASE ---\n            generationStore.setGenerationStep('generating_images');\n            const fullContent = sectionBodies.join('\\n\\n');\n\n            try {\n                appendAnalysisLog('Planning visual assets...');\n                const imagePlans = await planImagesForArticle(\n                    fullContent,\n                    analysisStore.scrapedImages,\n                    config.targetAudience,\n                    analysisStore.visualStyle\n                );\n\n                console.log(`[Images] Planned ${imagePlans.data.length} images`);\n                appendAnalysisLog(`Visual plan ready: ${imagePlans.data.length} images.`);\n                metricsStore.addCost(imagePlans.cost.totalCost, imagePlans.usage.totalTokens);\n\n                // Generate images in parallel (limit concurrency if needed, but for now all at once is fine for small batches)\n                const imagePromises = imagePlans.data.map(async (plan) => {\n                    if (isStopped()) return;\n                    try {\n                        const label = plan.category || plan.insertAfter || plan.id;\n                        appendAnalysisLog(`Generating image: ${label}...`);\n                        const imgRes = await generateImage(plan.generatedPrompt);\n\n                        if (imgRes.data) {\n                            // In a real app, you'd save this to a store or insert it into the content.\n                            // For now, we'll just log it and maybe append it to the end or store it.\n                            // TODO: Store generated images in a store for the UI to display or insert.\n                            console.log(`[Images] Generated: ${plan.id}`);\n                            metricsStore.addCost(imgRes.cost.totalCost, imgRes.usage.totalTokens);\n                        }\n                    } catch (e) {\n                        console.error(`Failed to generate image ${plan.id}`, e);\n                    }\n                });\n\n                await Promise.all(imagePromises);\n                appendAnalysisLog('Image generation completed.');\n\n            } catch (e) {\n                console.error(\"Image generation phase failed\", e);\n                appendAnalysisLog('Image generation failed.');\n            }\n        } else {\n            appendAnalysisLog('Skipping auto image planning (manual only).');\n        }\n\n        // --- REGION LOCALIZATION skipped as requested ---\n        generationStore.setGenerationStep('finalizing');\n        // FIX: Ensure immediate completion so the content is visible under the modal\n        generationStore.setStatus('completed');\n        generationStore.setGenerationStep('idle');\n    }\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2334, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useGeneration.ts"],"sourcesContent":["import { useCallback } from 'react';\nimport { useMutation } from '@tanstack/react-query';\nimport { ArticleConfig } from '@/types';\nimport { useGenerationStore } from '@/store/useGenerationStore';\nimport { useAnalysisStore } from '@/store/useAnalysisStore';\nimport { resetGenerationState } from '@/store/resetGenerationState';\nimport { runAnalysisPipeline } from './generation/useAnalysisPipeline';\nimport { runContentGeneration } from './generation/useContentGenerator';\n\nconst runAnalysisOnly = async (config: ArticleConfig) => {\n    const generationStore = useGenerationStore.getState();\n\n    // Reset State\n    resetGenerationState();\n    generationStore.setError(null);\n    generationStore.setLastConfig(config);\n\n    try {\n        // 1. Analysis Phase\n        const analysisResults = await runAnalysisPipeline(config);\n\n        if (useGenerationStore.getState().isStopped) return;\n\n        generationStore.setAnalysisResults(analysisResults);\n        generationStore.setStatus('analysis_ready');\n        generationStore.setGenerationStep('idle');\n\n    } catch (err: any) {\n        console.error(err);\n        generationStore.setError(err.message || \"An unexpected error occurred during generation.\");\n        generationStore.setStatus('error');\n        generationStore.setGenerationStep('idle');\n    }\n};\n\nconst runWritingPhase = async () => {\n    const generationStore = useGenerationStore.getState();\n    const analysisResults = generationStore.analysisResults;\n    const config = generationStore.lastConfig;\n\n    if (!analysisResults || !config) {\n        generationStore.setError('尚未完成分析，無法生成段落。請先執行分析。');\n        generationStore.setStatus('error');\n        return;\n    }\n\n    // Check for accumulated analysis errors\n    const missingData: string[] = [];\n    if (!analysisResults.structureResult?.structRes?.data?.structure?.length) missingData.push('文章架構 (Structure)');\n    if (!analysisResults.structureResult?.authRes?.data) missingData.push('權威分析 (Authority)');\n    if (!useAnalysisStore.getState().keywordPlans?.length) missingData.push('關鍵字規劃 (Keywords)');\n\n    if (missingData.length > 0) {\n        const confirmMsg = `偵測到部分分析資料缺失：\\n${missingData.map(s => `- ${s}`).join('\\n')}\\n\\n是否仍要嘗試生成？(選擇「取消」將重新執行分析)`;\n        if (!window.confirm(confirmMsg)) {\n            // User chose to retry analysis\n            // We need to trigger analysis again. Since we can't easily call the mutation from here without passing it in,\n            // we'll throw a special error or handle it in the component.\n            // Ideally, we should just return here and let the user click \"Generate\" again, \n            // but to be helpful we can reset the status so they can click \"Generate\" immediately.\n            generationStore.setStatus('idle');\n            return;\n        }\n    }\n\n    generationStore.setError(null);\n    try {\n        await runContentGeneration(config, analysisResults);\n    } catch (err: any) {\n        console.error(err);\n        generationStore.setError(err?.message || '生成段落時發生錯誤，請重試。');\n        generationStore.setStatus('error');\n        generationStore.setGenerationStep('idle');\n    }\n};\n\nexport const useGeneration = () => {\n    const mutation = useMutation({\n        mutationFn: (config: ArticleConfig) => runAnalysisOnly(config),\n    });\n\n    const writeMutation = useMutation({\n        mutationFn: () => runWritingPhase(),\n    });\n\n    const generate = useCallback(async (config: ArticleConfig) => {\n        const genState = useGenerationStore.getState();\n        const hasExistingAnalysis = !!genState.analysisResults;\n        const hasExistingContent = (genState.content || '').trim().length > 0;\n\n        if (hasExistingAnalysis || hasExistingContent) {\n            const confirmed = window.confirm('已經有分析結果或內容，重新分析會覆蓋目前的資料，確定要繼續嗎？');\n            if (!confirmed) return;\n        }\n\n        await mutation.mutateAsync(config);\n    }, [mutation]);\n\n    const startWriting = useCallback(async () => {\n        await writeMutation.mutateAsync();\n    }, [writeMutation]);\n\n    const stop = useCallback(() => {\n        useGenerationStore.getState().stopGeneration();\n    }, []);\n\n    return { generate, startWriting, stop, status: mutation.status };\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;;;;;;;;AAEA,MAAM,kBAAkB,OAAO;IAC3B,MAAM,kBAAkB,wJAAkB,CAAC,QAAQ;IAEnD,cAAc;IACd,IAAA,4JAAoB;IACpB,gBAAgB,QAAQ,CAAC;IACzB,gBAAgB,aAAa,CAAC;IAE9B,IAAI;QACA,oBAAoB;QACpB,MAAM,kBAAkB,MAAM,IAAA,wKAAmB,EAAC;QAElD,IAAI,wJAAkB,CAAC,QAAQ,GAAG,SAAS,EAAE;QAE7C,gBAAgB,kBAAkB,CAAC;QACnC,gBAAgB,SAAS,CAAC;QAC1B,gBAAgB,iBAAiB,CAAC;IAEtC,EAAE,OAAO,KAAU;QACf,QAAQ,KAAK,CAAC;QACd,gBAAgB,QAAQ,CAAC,IAAI,OAAO,IAAI;QACxC,gBAAgB,SAAS,CAAC;QAC1B,gBAAgB,iBAAiB,CAAC;IACtC;AACJ;AAEA,MAAM,kBAAkB;IACpB,MAAM,kBAAkB,wJAAkB,CAAC,QAAQ;IACnD,MAAM,kBAAkB,gBAAgB,eAAe;IACvD,MAAM,SAAS,gBAAgB,UAAU;IAEzC,IAAI,CAAC,mBAAmB,CAAC,QAAQ;QAC7B,gBAAgB,QAAQ,CAAC;QACzB,gBAAgB,SAAS,CAAC;QAC1B;IACJ;IAEA,wCAAwC;IACxC,MAAM,cAAwB,EAAE;IAChC,IAAI,CAAC,gBAAgB,eAAe,EAAE,WAAW,MAAM,WAAW,QAAQ,YAAY,IAAI,CAAC;IAC3F,IAAI,CAAC,gBAAgB,eAAe,EAAE,SAAS,MAAM,YAAY,IAAI,CAAC;IACtE,IAAI,CAAC,oJAAgB,CAAC,QAAQ,GAAG,YAAY,EAAE,QAAQ,YAAY,IAAI,CAAC;IAExE,IAAI,YAAY,MAAM,GAAG,GAAG;QACxB,MAAM,aAAa,CAAC,cAAc,EAAE,YAAY,GAAG,CAAC,CAAA,IAAK,CAAC,EAAE,EAAE,GAAG,EAAE,IAAI,CAAC,MAAM,4BAA4B,CAAC;QAC3G,IAAI,CAAC,OAAO,OAAO,CAAC,aAAa;YAC7B,+BAA+B;YAC/B,8GAA8G;YAC9G,6DAA6D;YAC7D,gFAAgF;YAChF,sFAAsF;YACtF,gBAAgB,SAAS,CAAC;YAC1B;QACJ;IACJ;IAEA,gBAAgB,QAAQ,CAAC;IACzB,IAAI;QACA,MAAM,IAAA,yKAAoB,EAAC,QAAQ;IACvC,EAAE,OAAO,KAAU;QACf,QAAQ,KAAK,CAAC;QACd,gBAAgB,QAAQ,CAAC,KAAK,WAAW;QACzC,gBAAgB,SAAS,CAAC;QAC1B,gBAAgB,iBAAiB,CAAC;IACtC;AACJ;AAEO,MAAM,gBAAgB;IACzB,MAAM,WAAW,IAAA,6LAAW,EAAC;QACzB,YAAY,CAAC,SAA0B,gBAAgB;IAC3D;IAEA,MAAM,gBAAgB,IAAA,6LAAW,EAAC;QAC9B,YAAY,IAAM;IACtB;IAEA,MAAM,WAAW,IAAA,oNAAW,EAAC,OAAO;QAChC,MAAM,WAAW,wJAAkB,CAAC,QAAQ;QAC5C,MAAM,sBAAsB,CAAC,CAAC,SAAS,eAAe;QACtD,MAAM,qBAAqB,CAAC,SAAS,OAAO,IAAI,EAAE,EAAE,IAAI,GAAG,MAAM,GAAG;QAEpE,IAAI,uBAAuB,oBAAoB;YAC3C,MAAM,YAAY,OAAO,OAAO,CAAC;YACjC,IAAI,CAAC,WAAW;QACpB;QAEA,MAAM,SAAS,WAAW,CAAC;IAC/B,GAAG;QAAC;KAAS;IAEb,MAAM,eAAe,IAAA,oNAAW,EAAC;QAC7B,MAAM,cAAc,WAAW;IACnC,GAAG;QAAC;KAAc;IAElB,MAAM,OAAO,IAAA,oNAAW,EAAC;QACrB,wJAAkB,CAAC,QAAQ,GAAG,cAAc;IAChD,GAAG,EAAE;IAEL,OAAO;QAAE;QAAU;QAAc;QAAM,QAAQ,SAAS,MAAM;IAAC;AACnE"}},
    {"offset": {"line": 2446, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useAppAccess.ts"],"sourcesContent":["import { useEffect, useState } from 'react';\n\nconst ACCESS_KEY = 'app_access_granted';\nconst ACCESS_TS_KEY = 'app_access_granted_at';\nconst ACCESS_TTL_MS = 7 * 24 * 60 * 60 * 1000; // 7 days\n\nexport function useAppAccess() {\n    const [isUnlocked, setIsUnlocked] = useState(false);\n\n    useEffect(() => {\n        if (typeof window === 'undefined') return;\n        const stored = localStorage.getItem(ACCESS_KEY);\n        const tsRaw = localStorage.getItem(ACCESS_TS_KEY);\n\n        if (stored === '1' && tsRaw) {\n            const ts = Number(tsRaw);\n            if (!Number.isNaN(ts) && Date.now() - ts < ACCESS_TTL_MS) {\n                setIsUnlocked(true);\n                return;\n            }\n        }\n        localStorage.removeItem(ACCESS_KEY);\n        localStorage.removeItem(ACCESS_TS_KEY);\n    }, []);\n\n    const unlock = () => {\n        if (typeof window !== 'undefined') {\n            localStorage.setItem(ACCESS_KEY, '1');\n            localStorage.setItem(ACCESS_TS_KEY, Date.now().toString());\n        }\n        setIsUnlocked(true);\n    };\n\n    return { isUnlocked, unlock };\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,aAAa;AACnB,MAAM,gBAAgB;AACtB,MAAM,gBAAgB,IAAI,KAAK,KAAK,KAAK,MAAM,SAAS;AAEjD,SAAS;IACZ,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,iNAAQ,EAAC;IAE7C,IAAA,kNAAS,EAAC;QACN,wCAAmC;;;QACnC,MAAM;QACN,MAAM;IAWV,GAAG,EAAE;IAEL,MAAM,SAAS;QACX;;QAIA,cAAc;IAClB;IAEA,OAAO;QAAE;QAAY;IAAO;AAChC"}},
    {"offset": {"line": 2478, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useContentScore.ts"],"sourcesContent":["import { useEffect, useMemo } from 'react';\nimport { useGenerationStore } from '@/store/useGenerationStore';\nimport { useAnalysisStore } from '@/store/useAnalysisStore';\nimport { useAppStore } from '@/store/useAppStore';\n\nexport function useContentScore() {\n    const generationStore = useGenerationStore();\n    const analysisStore = useAnalysisStore();\n    const { contentScore, setContentScore } = useAppStore();\n\n    const structurePoints = useMemo(() => {\n        const structure = analysisStore.refAnalysis?.structure || [];\n        const general = new Set<string>();\n        const brand = new Set<string>();\n        const legacyGeneral = Array.isArray(analysisStore.refAnalysis?.keyInformationPoints)\n            ? analysisStore.refAnalysis?.keyInformationPoints\n            : [];\n        const legacyBrand = Array.isArray(analysisStore.refAnalysis?.brandExclusivePoints)\n            ? analysisStore.refAnalysis?.brandExclusivePoints\n            : [];\n\n        legacyGeneral.forEach(p => { if (p) general.add(p); });\n        legacyBrand.forEach(p => { if (p) brand.add(p); });\n        structure.forEach((s: any) => {\n            (Array.isArray(s?.keyFacts) ? s.keyFacts : []).forEach((p: string) => {\n                if (p) general.add(p);\n            });\n            (Array.isArray(s?.uspNotes) ? s.uspNotes : []).forEach((p: string) => {\n                if (p) brand.add(p);\n            });\n        });\n        return {\n            general: Array.from(general),\n            brand: Array.from(brand),\n        };\n    }, [analysisStore.refAnalysis]);\n\n    useEffect(() => {\n        if (!generationStore.content || generationStore.status === 'idle') {\n            const baseScore = { value: 0, label: 'Start Writing', color: 'text-gray-300' };\n            if (contentScore.value !== baseScore.value) {\n                setContentScore(baseScore);\n            }\n            return;\n        }\n\n        let score = 0;\n        let totalFactors = 0;\n\n        if (analysisStore.keywordPlans.length > 0) {\n            const contentLower = (generationStore.content || '').toLowerCase();\n            const usedKeywords = analysisStore.keywordPlans.filter(k => k.word && contentLower.includes(k.word.toLowerCase()));\n            const keywordRatio = usedKeywords.length / analysisStore.keywordPlans.length;\n            score += keywordRatio * 50;\n            totalFactors++;\n        }\n\n        const totalPointCount = structurePoints.general.length + structurePoints.brand.length;\n        if (totalPointCount > 0) {\n            const pointRatio = analysisStore.coveredPoints.length / totalPointCount;\n            score += pointRatio * 50;\n            totalFactors++;\n        } else {\n            score += 50;\n        }\n\n        if (analysisStore.keywordPlans.length === 0) score = score * 2;\n        score = Math.min(100, Math.round(score));\n\n        let label = 'Needs Work';\n        let color = 'text-red-500';\n        if (score >= 80) {\n            label = 'Excellent';\n            color = 'text-emerald-500';\n        } else if (score >= 50) {\n            label = 'Good';\n            color = 'text-amber-500';\n        }\n\n        const nextScore = { value: score, label, color };\n        if (contentScore.value !== nextScore.value || contentScore.label !== nextScore.label) {\n            setContentScore(nextScore);\n        }\n    }, [\n        generationStore.content,\n        analysisStore.keywordPlans,\n        analysisStore.coveredPoints,\n        analysisStore.refAnalysis,\n        structurePoints,\n        generationStore.status,\n        contentScore.value,\n        contentScore.label,\n        setContentScore\n    ]);\n\n    return { structurePoints };\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEO,SAAS;IACZ,MAAM,kBAAkB,IAAA,wJAAkB;IAC1C,MAAM,gBAAgB,IAAA,oJAAgB;IACtC,MAAM,EAAE,YAAY,EAAE,eAAe,EAAE,GAAG,IAAA,0IAAW;IAErD,MAAM,kBAAkB,IAAA,gNAAO,EAAC;QAC5B,MAAM,YAAY,cAAc,WAAW,EAAE,aAAa,EAAE;QAC5D,MAAM,UAAU,IAAI;QACpB,MAAM,QAAQ,IAAI;QAClB,MAAM,gBAAgB,MAAM,OAAO,CAAC,cAAc,WAAW,EAAE,wBACzD,cAAc,WAAW,EAAE,uBAC3B,EAAE;QACR,MAAM,cAAc,MAAM,OAAO,CAAC,cAAc,WAAW,EAAE,wBACvD,cAAc,WAAW,EAAE,uBAC3B,EAAE;QAER,cAAc,OAAO,CAAC,CAAA;YAAO,IAAI,GAAG,QAAQ,GAAG,CAAC;QAAI;QACpD,YAAY,OAAO,CAAC,CAAA;YAAO,IAAI,GAAG,MAAM,GAAG,CAAC;QAAI;QAChD,UAAU,OAAO,CAAC,CAAC;YACf,CAAC,MAAM,OAAO,CAAC,GAAG,YAAY,EAAE,QAAQ,GAAG,EAAE,EAAE,OAAO,CAAC,CAAC;gBACpD,IAAI,GAAG,QAAQ,GAAG,CAAC;YACvB;YACA,CAAC,MAAM,OAAO,CAAC,GAAG,YAAY,EAAE,QAAQ,GAAG,EAAE,EAAE,OAAO,CAAC,CAAC;gBACpD,IAAI,GAAG,MAAM,GAAG,CAAC;YACrB;QACJ;QACA,OAAO;YACH,SAAS,MAAM,IAAI,CAAC;YACpB,OAAO,MAAM,IAAI,CAAC;QACtB;IACJ,GAAG;QAAC,cAAc,WAAW;KAAC;IAE9B,IAAA,kNAAS,EAAC;QACN,IAAI,CAAC,gBAAgB,OAAO,IAAI,gBAAgB,MAAM,KAAK,QAAQ;YAC/D,MAAM,YAAY;gBAAE,OAAO;gBAAG,OAAO;gBAAiB,OAAO;YAAgB;YAC7E,IAAI,aAAa,KAAK,KAAK,UAAU,KAAK,EAAE;gBACxC,gBAAgB;YACpB;YACA;QACJ;QAEA,IAAI,QAAQ;QACZ,IAAI,eAAe;QAEnB,IAAI,cAAc,YAAY,CAAC,MAAM,GAAG,GAAG;YACvC,MAAM,eAAe,CAAC,gBAAgB,OAAO,IAAI,EAAE,EAAE,WAAW;YAChE,MAAM,eAAe,cAAc,YAAY,CAAC,MAAM,CAAC,CAAA,IAAK,EAAE,IAAI,IAAI,aAAa,QAAQ,CAAC,EAAE,IAAI,CAAC,WAAW;YAC9G,MAAM,eAAe,aAAa,MAAM,GAAG,cAAc,YAAY,CAAC,MAAM;YAC5E,SAAS,eAAe;YACxB;QACJ;QAEA,MAAM,kBAAkB,gBAAgB,OAAO,CAAC,MAAM,GAAG,gBAAgB,KAAK,CAAC,MAAM;QACrF,IAAI,kBAAkB,GAAG;YACrB,MAAM,aAAa,cAAc,aAAa,CAAC,MAAM,GAAG;YACxD,SAAS,aAAa;YACtB;QACJ,OAAO;YACH,SAAS;QACb;QAEA,IAAI,cAAc,YAAY,CAAC,MAAM,KAAK,GAAG,QAAQ,QAAQ;QAC7D,QAAQ,KAAK,GAAG,CAAC,KAAK,KAAK,KAAK,CAAC;QAEjC,IAAI,QAAQ;QACZ,IAAI,QAAQ;QACZ,IAAI,SAAS,IAAI;YACb,QAAQ;YACR,QAAQ;QACZ,OAAO,IAAI,SAAS,IAAI;YACpB,QAAQ;YACR,QAAQ;QACZ;QAEA,MAAM,YAAY;YAAE,OAAO;YAAO;YAAO;QAAM;QAC/C,IAAI,aAAa,KAAK,KAAK,UAAU,KAAK,IAAI,aAAa,KAAK,KAAK,UAAU,KAAK,EAAE;YAClF,gBAAgB;QACpB;IACJ,GAAG;QACC,gBAAgB,OAAO;QACvB,cAAc,YAAY;QAC1B,cAAc,aAAa;QAC3B,cAAc,WAAW;QACzB;QACA,gBAAgB,MAAM;QACtB,aAAa,KAAK;QAClB,aAAa,KAAK;QAClB;KACH;IAED,OAAO;QAAE;IAAgB;AAC7B"}},
    {"offset": {"line": 2588, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/hooks/useAppHydration.ts"],"sourcesContent":["import { useEffect, useRef } from 'react';\nimport { useGenerationStore } from '@/store/useGenerationStore';\nimport { useAnalysisStore } from '@/store/useAnalysisStore';\n\nexport function useAppHydration() {\n    const generationStore = useGenerationStore();\n    const analysisStore = useAnalysisStore();\n    const restorePromptedRef = useRef(false);\n    const hydratedAnalysisRef = useRef(false);\n\n    useEffect(() => {\n        if (restorePromptedRef.current || typeof window === 'undefined') return;\n        const persistedKeys = [\n            'pro_content_writer_analysis',\n            'pro_content_writer_generation',\n            'pro_content_writer_inputs_simple_v4',\n            'ai_writer_editor_autosave_v1'\n        ];\n        const hasPersisted = persistedKeys.some(k => localStorage.getItem(k));\n\n        if (!hasPersisted) return;\n        restorePromptedRef.current = true;\n        const shouldRestore = window.confirm('偵測到上次的資料，是否恢復? 選擇「取消」將清空並重新開始。');\n        if (!shouldRestore) {\n            persistedKeys.forEach(k => localStorage.removeItem(k));\n            analysisStore.reset();\n            generationStore.resetGeneration();\n        }\n    }, [analysisStore, generationStore]);\n\n    useEffect(() => {\n        if (hydratedAnalysisRef.current || generationStore.status !== 'idle' || generationStore.analysisResults || typeof window === 'undefined') return;\n\n        const hasAnalysisState =\n            Boolean(analysisStore.refAnalysis?.structure?.length) ||\n            Boolean(analysisStore.keywordPlans.length) ||\n            Boolean(analysisStore.authAnalysis);\n\n        if (!hasAnalysisState) return;\n\n        const savedRaw = localStorage.getItem('pro_content_writer_inputs_simple_v4');\n        if (!savedRaw) return;\n\n        let saved: any;\n        try { saved = JSON.parse(savedRaw); } catch (e) { return; }\n\n        const title = (saved?.title || analysisStore.articleTitle || '').trim();\n        const referenceContent = (saved?.referenceContent || '').trim();\n        if (!title || !referenceContent) return;\n\n        const restoredConfig = {\n            title,\n            referenceContent,\n            sampleOutline: saved?.sampleOutline || '',\n            authorityTerms: saved?.authorityTerms || '',\n            websiteType: saved?.websiteType || '',\n            targetAudience: saved?.targetAudience || analysisStore.targetAudience || 'zh-TW',\n            useRag: !!saved?.useRag,\n            autoImagePlan: !!saved?.autoImagePlan,\n            productRawText: saved?.productRawText || '',\n            scrapedImages: saved?.scrapedImages || analysisStore.scrapedImages || [],\n            brandKnowledge: analysisStore.brandKnowledge,\n        };\n\n        if (restoredConfig.productRawText?.trim() && !analysisStore.activeProductBrief?.productName) return;\n\n        generationStore.setLastConfig(restoredConfig);\n        generationStore.setAnalysisResults({\n            productResult: { brief: analysisStore.activeProductBrief, mapping: analysisStore.productMapping },\n            structureResult: {\n                structRes: { data: analysisStore.refAnalysis },\n                authRes: { data: analysisStore.authAnalysis },\n            }\n        });\n        generationStore.setStatus('analysis_ready');\n        generationStore.setGenerationStep('idle');\n        generationStore.setError(null);\n        hydratedAnalysisRef.current = true;\n    }, [analysisStore, generationStore]);\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,SAAS;IACZ,MAAM,kBAAkB,IAAA,wJAAkB;IAC1C,MAAM,gBAAgB,IAAA,oJAAgB;IACtC,MAAM,qBAAqB,IAAA,+MAAM,EAAC;IAClC,MAAM,sBAAsB,IAAA,+MAAM,EAAC;IAEnC,IAAA,kNAAS,EAAC;QACN,wCAAiE;;;QACjE,MAAM;QAMN,MAAM;QAIN,MAAM;IAMV,GAAG;QAAC;QAAe;KAAgB;IAEnC,IAAA,kNAAS,EAAC;QACN,wCAA0I;;;QAE1I,MAAM;QAON,MAAM;QAGN,IAAI;QAGJ,MAAM;QACN,MAAM;QAGN,MAAM;IA4BV,GAAG;QAAC;QAAe;KAAgB;AACvC"}},
    {"offset": {"line": 2633, "column": 0}, "map": {"version":3,"sources":["file:///Users/rose/Documents/this_month/write-content/best-ai-text-writer.com/src/app/page.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useMemo, useState } from 'react';\nimport { Header } from '@/components/Header';\nimport { InputForm } from '@/components/InputForm';\nimport { Preview } from '@/components/Preview';\nimport { SeoSidebar } from '@/components/SeoSidebar';\nimport { Changelog } from '@/components/Changelog';\nimport { PasswordGate } from '@/components/PasswordGate';\nimport { useGeneration } from '@/hooks/useGeneration';\nimport { parseProductContext } from '@/services/research/productFeatureToPainPointMapper';\nimport { findRegionEquivalents, localizePlanWithAI } from '@/services/research/regionGroundingService';\nimport { SavedProfile, ScrapedImage } from '@/types';\nimport { useGenerationStore } from '@/store/useGenerationStore';\nimport { useAnalysisStore } from '@/store/useAnalysisStore';\nimport { useAppStore } from '@/store/useAppStore';\nimport { SectionPlanModal } from '@/components/SectionPlanModal';\nimport { SettingsModal } from '@/components/SettingsModal';\nimport { useAppAccess } from '@/hooks/useAppAccess';\nimport { useContentScore } from '@/hooks/useContentScore';\nimport { useAppHydration } from '@/hooks/useAppHydration';\n\nexport default function AppPage() {\n    const passwordHash = useMemo(() => (process.env.NEXT_PUBLIC_APP_GUARD_HASH as string) || '', []);\n\n    // Store & Hooks\n    const app = useAppStore();\n    const generationStore = useGenerationStore();\n    const analysisStore = useAnalysisStore();\n    const { isUnlocked, unlock } = useAppAccess();\n    const { structurePoints } = useContentScore();\n    const { generate, startWriting, stop } = useGeneration();\n    useAppHydration();\n\n    const [isSearchingAlternatives, setIsSearchingAlternatives] = useState(false);\n    const [isLocalizingPlan, setIsLocalizingPlan] = useState(false);\n\n    // Sidebar Auto-show\n    useEffect(() => {\n        if (generationStore.status === 'analyzing' && !app.showSidebar) {\n            app.setShowSidebar(true);\n        }\n    }, [generationStore.status, app]);\n\n    // Plan Modal Auto-show\n    useEffect(() => {\n        const hasStructure = Boolean(analysisStore.refAnalysis?.structure?.length);\n        if (generationStore.status === 'analysis_ready' && hasStructure && !app.showPlanModal) {\n            // Only show if we just finished analysis\n            if (generationStore.generationStep === 'idle') {\n                app.setShowPlanModal(true);\n            }\n        }\n    }, [generationStore.status, generationStore.generationStep, analysisStore.refAnalysis?.structure, app]);\n\n    const handleLoadProfile = async (profile: SavedProfile) => {\n        app.setActiveProfile(profile);\n        analysisStore.setTargetAudience(profile.targetAudience);\n        analysisStore.setBrandKnowledge(profile.brandKnowledge || '');\n\n        if (profile.productRawText) {\n            const res = await parseProductContext(profile.productRawText);\n            analysisStore.setActiveProductBrief(res.data);\n        }\n    };\n\n    const handleRemoveScrapedImage = (image: ScrapedImage) => {\n        const keyToMatch = image.id || image.url || image.altText;\n        if (!keyToMatch) return;\n        const updated = analysisStore.scrapedImages.map((img, idx) => {\n            const key = img.id || img.url || img.altText || `${idx}`;\n            if (key !== keyToMatch) return img;\n            return { ...img, ignored: !img.ignored };\n        });\n        analysisStore.setScrapedImages(updated);\n    };\n\n    const handleSearchLocalAlternatives = async () => {\n        const refAnalysis = analysisStore.refAnalysis;\n        if (!refAnalysis) return;\n\n        const entities = [\n            ...(refAnalysis.competitorBrands || []).map(b => ({ text: b, type: 'brand' as const, region: 'OTHER' })),\n            ...(refAnalysis.competitorProducts || []).map(p => ({ text: p, type: 'service' as const, region: 'OTHER' }))\n        ];\n\n        if (entities.length === 0) return;\n\n        setIsSearchingAlternatives(true);\n        try {\n            const result = await findRegionEquivalents(entities, analysisStore.targetAudience);\n            app.addCost(result.cost.totalCost, result.usage.totalTokens);\n\n            if (result.mappings.length > 0) {\n                const existingReplacements = refAnalysis.regionalReplacements || [];\n                const newReplacements = result.mappings.map(m => ({\n                    original: m.original,\n                    replacement: m.regionEquivalent,\n                    reason: m.context\n                }));\n\n                const mergedReplacements = [...existingReplacements];\n                newReplacements.forEach(nr => {\n                    if (!mergedReplacements.some(er => er.original === nr.original)) {\n                        mergedReplacements.push(nr);\n                    }\n                });\n\n                analysisStore.setRefAnalysis({ ...refAnalysis, regionalReplacements: mergedReplacements });\n            }\n        } catch (error) {\n            console.error('[App] Search local alternatives failed', error);\n        } finally {\n            setIsSearchingAlternatives(false);\n        }\n    };\n\n    if (!isUnlocked) {\n        return <PasswordGate passwordHash={passwordHash} onUnlock={unlock} />;\n    }\n\n    return (\n        <div className=\"flex flex-col h-screen overflow-hidden\">\n            <Header\n                sessionCost={app.sessionCost}\n                sessionTokens={app.sessionTokens}\n                showInput={app.showInput}\n                showSidebar={app.showSidebar}\n                onToggleInput={app.toggleInput}\n                onToggleSidebar={app.toggleSidebar}\n                onToggleChangelog={() => app.setShowChangelog(true)}\n                onToggleSettings={() => app.setShowSettings(true)}\n                contentScore={app.contentScore}\n                displayScale={app.displayScale}\n                onDisplayScaleChange={app.setDisplayScale}\n            />\n\n            <Changelog isOpen={app.showChangelog} onClose={() => app.setShowChangelog(false)} />\n            <SettingsModal open={app.showSettings} onClose={() => app.setShowSettings(false)} />\n\n            <main className=\"flex-1 flex flex-col lg:flex-row overflow-hidden h-[calc(100vh-64px)] min-h-0 bg-gray-100 p-4 gap-4\">\n                {app.showInput && (\n                    <section className=\"w-full lg:w-[380px] bg-white rounded-2xl shadow-sm border border-gray-200/60 flex flex-col overflow-auto z-20 transition-all duration-300\">\n                        <InputForm\n                            onGenerate={generate}\n                            onGenerateSections={startWriting}\n                            isGenerating={generationStore.status === 'analyzing' || generationStore.status === 'streaming'}\n                            isWriting={generationStore.status === 'streaming'}\n                            canGenerateSections={generationStore.status === 'analysis_ready'}\n                            currentStep={generationStore.generationStep}\n                            onAddCost={(cost, usage) => app.addCost(cost.totalCost, usage.totalTokens)}\n                            savedProfiles={app.savedProfiles}\n                            setSavedProfiles={app.setSavedProfiles}\n                            activeProfile={app.activeProfile}\n                            onSetActiveProfile={app.setActiveProfile}\n                            inputType={app.inputType}\n                            setInputType={app.setInputType}\n                            brandKnowledge={analysisStore.brandKnowledge}\n                            onShowPlan={() => app.setShowPlanModal(true)}\n                            hasPlan={Boolean(analysisStore.refAnalysis?.structure?.length)}\n                        />\n                    </section>\n                )}\n\n                <section className=\"flex-1 bg-white rounded-2xl shadow-sm border border-gray-200/60 flex flex-col min-h-0 relative overflow-hidden\">\n                    <Preview\n                        content={generationStore.content}\n                        status={generationStore.status}\n                        error={generationStore.error}\n                        generationStep={generationStore.generationStep}\n                        coveredPoints={analysisStore.coveredPoints}\n                        targetAudience={analysisStore.targetAudience}\n                        scrapedImages={analysisStore.scrapedImages}\n                        visualStyle={analysisStore.visualStyle}\n                        onRemoveScrapedImage={handleRemoveScrapedImage}\n                        onTogglePoint={(point) => {\n                            analysisStore.setCoveredPoints(prev =>\n                                prev.includes(point) ? prev.filter(p => p !== point) : [...prev, point]\n                            );\n                        }}\n                        onAddCost={(cost, usage) => app.addCost(cost.totalCost, usage.totalTokens)}\n                        savedProfiles={app.savedProfiles}\n                        onLoadProfile={handleLoadProfile}\n                        onRequestUrlMode={() => app.setInputType('url')}\n                        productBrief={analysisStore.activeProductBrief}\n                        displayScale={app.displayScale}\n                        articleTitle={analysisStore.articleTitle}\n                        onTitleChange={analysisStore.setArticleTitle}\n                        outlineSections={analysisStore.refAnalysis?.structure?.map(s => s.title) || []}\n                        keyInformationPoints={structurePoints.general}\n                        brandExclusivePoints={structurePoints.brand}\n                    />\n                </section>\n\n                {app.showSidebar && (\n                    <section className=\"hidden lg:flex w-[380px] bg-white rounded-2xl shadow-sm border border-gray-200/60 flex-col overflow-auto z-10 transition-all duration-300\">\n                        <SeoSidebar\n                            keywordPlans={analysisStore.keywordPlans}\n                            referenceAnalysis={analysisStore.refAnalysis}\n                            authorityAnalysis={analysisStore.authAnalysis}\n                            productMapping={analysisStore.productMapping}\n                            productBrief={analysisStore.activeProductBrief}\n                            headingOptimizations={analysisStore.headingOptimizations}\n                            targetAudience={analysisStore.targetAudience}\n                            languageInstruction={analysisStore.languageInstruction}\n                            isLoading={generationStore.status === 'analyzing'}\n                            status={generationStore.status}\n                            onStop={stop}\n                            brandKnowledge={analysisStore.brandKnowledge}\n                            setBrandKnowledge={analysisStore.setBrandKnowledge}\n                            displayScale={app.displayScale}\n                            onSearchLocalAlternatives={handleSearchLocalAlternatives}\n                            isSearchingAlternatives={isSearchingAlternatives}\n                        />\n                    </section>\n                )}\n            </main>\n\n            <SectionPlanModal\n                open={app.showPlanModal}\n                onClose={() => app.setShowPlanModal(false)}\n                sections={analysisStore.refAnalysis?.structure || []}\n                generalPlan={analysisStore.refAnalysis?.generalPlan}\n                conversionPlan={analysisStore.refAnalysis?.conversionPlan}\n                regionalReplacements={analysisStore.refAnalysis?.regionalReplacements}\n                localizedSections={analysisStore.localizedRefAnalysis?.structure}\n                localizedGeneralPlan={analysisStore.localizedRefAnalysis?.generalPlan}\n                localizedConversionPlan={analysisStore.localizedRefAnalysis?.conversionPlan}\n                onSavePlan={(updated) => {\n                    const current = analysisStore.refAnalysis;\n                    if (!current) return;\n                    analysisStore.setRefAnalysis({ ...current, structure: updated });\n                }}\n                onLocalizeAll={async () => {\n                    const current = analysisStore.refAnalysis;\n                    if (!current || !current.regionalReplacements?.length) return;\n\n                    setIsLocalizingPlan(true);\n                    try {\n                        const result = await localizePlanWithAI(\n                            {\n                                generalPlan: current.generalPlan || [],\n                                conversionPlan: current.conversionPlan || [],\n                                sections: current.structure.map(s => ({\n                                    title: s.title,\n                                    narrativePlan: s.narrativePlan,\n                                    keyFacts: s.keyFacts,\n                                    uspNotes: s.uspNotes,\n                                    subheadings: s.subheadings\n                                }))\n                            },\n                            current.regionalReplacements,\n                            analysisStore.targetAudience\n                        );\n\n                        app.addCost(result.cost.totalCost, result.usage.totalTokens);\n\n                        const localizedStructure = current.structure.map((original, idx) => ({\n                            ...original,\n                            title: result.localizedSections[idx]?.title || original.title,\n                            narrativePlan: result.localizedSections[idx]?.narrativePlan || original.narrativePlan,\n                            keyFacts: result.localizedSections[idx]?.keyFacts || original.keyFacts,\n                            uspNotes: result.localizedSections[idx]?.uspNotes || original.uspNotes,\n                            subheadings: result.localizedSections[idx]?.subheadings || original.subheadings\n                        }));\n\n                        analysisStore.setLocalizedRefAnalysis({\n                            ...current,\n                            structure: localizedStructure,\n                            generalPlan: result.localizedGeneralPlan,\n                            conversionPlan: result.localizedConversionPlan,\n                        });\n                    } catch (error) {\n                        console.error('[App] AI Plan localization failed', error);\n                    } finally {\n                        setIsLocalizingPlan(false);\n                    }\n                }}\n                isLocalizing={isLocalizingPlan}\n                onStartWriting={(selected) => {\n                    const current = analysisStore.refAnalysis;\n                    if (current) analysisStore.setRefAnalysis({ ...current, structure: selected });\n                    app.setShowPlanModal(false);\n                    startWriting();\n                }}\n                onSaveReplacements={(editedItems) => {\n                    const current = analysisStore.refAnalysis;\n                    if (!current) return;\n                    analysisStore.setRefAnalysis({\n                        ...current,\n                        regionalReplacements: editedItems\n                            .filter(i => i.action !== 'keep')\n                            .map(i => ({\n                                original: i.original,\n                                replacement: i.action === 'delete' ? '' : (i.customReplacement || i.replacement),\n                                reason: i.reason\n                            }))\n                    });\n                }}\n            />\n        </div>\n    );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AApBA;;;;;;;;;;;;;;;;;;;;AAsBe,SAAS;IACpB,MAAM,eAAe,IAAA,gNAAO,EAAC,IAAM,wGAAsD,IAAI,EAAE;IAE/F,gBAAgB;IAChB,MAAM,MAAM,IAAA,0IAAW;IACvB,MAAM,kBAAkB,IAAA,wJAAkB;IAC1C,MAAM,gBAAgB,IAAA,oJAAgB;IACtC,MAAM,EAAE,UAAU,EAAE,MAAM,EAAE,GAAG,IAAA,4IAAY;IAC3C,MAAM,EAAE,eAAe,EAAE,GAAG,IAAA,kJAAe;IAC3C,MAAM,EAAE,QAAQ,EAAE,YAAY,EAAE,IAAI,EAAE,GAAG,IAAA,8IAAa;IACtD,IAAA,kJAAe;IAEf,MAAM,CAAC,yBAAyB,2BAA2B,GAAG,IAAA,iNAAQ,EAAC;IACvE,MAAM,CAAC,kBAAkB,oBAAoB,GAAG,IAAA,iNAAQ,EAAC;IAEzD,oBAAoB;IACpB,IAAA,kNAAS,EAAC;QACN,IAAI,gBAAgB,MAAM,KAAK,eAAe,CAAC,IAAI,WAAW,EAAE;YAC5D,IAAI,cAAc,CAAC;QACvB;IACJ,GAAG;QAAC,gBAAgB,MAAM;QAAE;KAAI;IAEhC,uBAAuB;IACvB,IAAA,kNAAS,EAAC;QACN,MAAM,eAAe,QAAQ,cAAc,WAAW,EAAE,WAAW;QACnE,IAAI,gBAAgB,MAAM,KAAK,oBAAoB,gBAAgB,CAAC,IAAI,aAAa,EAAE;YACnF,yCAAyC;YACzC,IAAI,gBAAgB,cAAc,KAAK,QAAQ;gBAC3C,IAAI,gBAAgB,CAAC;YACzB;QACJ;IACJ,GAAG;QAAC,gBAAgB,MAAM;QAAE,gBAAgB,cAAc;QAAE,cAAc,WAAW,EAAE;QAAW;KAAI;IAEtG,MAAM,oBAAoB,OAAO;QAC7B,IAAI,gBAAgB,CAAC;QACrB,cAAc,iBAAiB,CAAC,QAAQ,cAAc;QACtD,cAAc,iBAAiB,CAAC,QAAQ,cAAc,IAAI;QAE1D,IAAI,QAAQ,cAAc,EAAE;YACxB,MAAM,MAAM,MAAM,IAAA,qLAAmB,EAAC,QAAQ,cAAc;YAC5D,cAAc,qBAAqB,CAAC,IAAI,IAAI;QAChD;IACJ;IAEA,MAAM,2BAA2B,CAAC;QAC9B,MAAM,aAAa,MAAM,EAAE,IAAI,MAAM,GAAG,IAAI,MAAM,OAAO;QACzD,IAAI,CAAC,YAAY;QACjB,MAAM,UAAU,cAAc,aAAa,CAAC,GAAG,CAAC,CAAC,KAAK;YAClD,MAAM,MAAM,IAAI,EAAE,IAAI,IAAI,GAAG,IAAI,IAAI,OAAO,IAAI,GAAG,KAAK;YACxD,IAAI,QAAQ,YAAY,OAAO;YAC/B,OAAO;gBAAE,GAAG,GAAG;gBAAE,SAAS,CAAC,IAAI,OAAO;YAAC;QAC3C;QACA,cAAc,gBAAgB,CAAC;IACnC;IAEA,MAAM,gCAAgC;QAClC,MAAM,cAAc,cAAc,WAAW;QAC7C,IAAI,CAAC,aAAa;QAElB,MAAM,WAAW;eACV,CAAC,YAAY,gBAAgB,IAAI,EAAE,EAAE,GAAG,CAAC,CAAA,IAAK,CAAC;oBAAE,MAAM;oBAAG,MAAM;oBAAkB,QAAQ;gBAAQ,CAAC;eACnG,CAAC,YAAY,kBAAkB,IAAI,EAAE,EAAE,GAAG,CAAC,CAAA,IAAK,CAAC;oBAAE,MAAM;oBAAG,MAAM;oBAAoB,QAAQ;gBAAQ,CAAC;SAC7G;QAED,IAAI,SAAS,MAAM,KAAK,GAAG;QAE3B,2BAA2B;QAC3B,IAAI;YACA,MAAM,SAAS,MAAM,IAAA,8KAAqB,EAAC,UAAU,cAAc,cAAc;YACjF,IAAI,OAAO,CAAC,OAAO,IAAI,CAAC,SAAS,EAAE,OAAO,KAAK,CAAC,WAAW;YAE3D,IAAI,OAAO,QAAQ,CAAC,MAAM,GAAG,GAAG;gBAC5B,MAAM,uBAAuB,YAAY,oBAAoB,IAAI,EAAE;gBACnE,MAAM,kBAAkB,OAAO,QAAQ,CAAC,GAAG,CAAC,CAAA,IAAK,CAAC;wBAC9C,UAAU,EAAE,QAAQ;wBACpB,aAAa,EAAE,gBAAgB;wBAC/B,QAAQ,EAAE,OAAO;oBACrB,CAAC;gBAED,MAAM,qBAAqB;uBAAI;iBAAqB;gBACpD,gBAAgB,OAAO,CAAC,CAAA;oBACpB,IAAI,CAAC,mBAAmB,IAAI,CAAC,CAAA,KAAM,GAAG,QAAQ,KAAK,GAAG,QAAQ,GAAG;wBAC7D,mBAAmB,IAAI,CAAC;oBAC5B;gBACJ;gBAEA,cAAc,cAAc,CAAC;oBAAE,GAAG,WAAW;oBAAE,sBAAsB;gBAAmB;YAC5F;QACJ,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,0CAA0C;QAC5D,SAAU;YACN,2BAA2B;QAC/B;IACJ;IAEA,IAAI,CAAC,YAAY;QACb,qBAAO,8OAAC,kJAAY;YAAC,cAAc;YAAc,UAAU;;;;;;IAC/D;IAEA,qBACI,8OAAC;QAAI,WAAU;;0BACX,8OAAC,sIAAM;gBACH,aAAa,IAAI,WAAW;gBAC5B,eAAe,IAAI,aAAa;gBAChC,WAAW,IAAI,SAAS;gBACxB,aAAa,IAAI,WAAW;gBAC5B,eAAe,IAAI,WAAW;gBAC9B,iBAAiB,IAAI,aAAa;gBAClC,mBAAmB,IAAM,IAAI,gBAAgB,CAAC;gBAC9C,kBAAkB,IAAM,IAAI,eAAe,CAAC;gBAC5C,cAAc,IAAI,YAAY;gBAC9B,cAAc,IAAI,YAAY;gBAC9B,sBAAsB,IAAI,eAAe;;;;;;0BAG7C,8OAAC,4IAAS;gBAAC,QAAQ,IAAI,aAAa;gBAAE,SAAS,IAAM,IAAI,gBAAgB,CAAC;;;;;;0BAC1E,8OAAC,oJAAa;gBAAC,MAAM,IAAI,YAAY;gBAAE,SAAS,IAAM,IAAI,eAAe,CAAC;;;;;;0BAE1E,8OAAC;gBAAK,WAAU;;oBACX,IAAI,SAAS,kBACV,8OAAC;wBAAQ,WAAU;kCACf,cAAA,8OAAC,4IAAS;4BACN,YAAY;4BACZ,oBAAoB;4BACpB,cAAc,gBAAgB,MAAM,KAAK,eAAe,gBAAgB,MAAM,KAAK;4BACnF,WAAW,gBAAgB,MAAM,KAAK;4BACtC,qBAAqB,gBAAgB,MAAM,KAAK;4BAChD,aAAa,gBAAgB,cAAc;4BAC3C,WAAW,CAAC,MAAM,QAAU,IAAI,OAAO,CAAC,KAAK,SAAS,EAAE,MAAM,WAAW;4BACzE,eAAe,IAAI,aAAa;4BAChC,kBAAkB,IAAI,gBAAgB;4BACtC,eAAe,IAAI,aAAa;4BAChC,oBAAoB,IAAI,gBAAgB;4BACxC,WAAW,IAAI,SAAS;4BACxB,cAAc,IAAI,YAAY;4BAC9B,gBAAgB,cAAc,cAAc;4BAC5C,YAAY,IAAM,IAAI,gBAAgB,CAAC;4BACvC,SAAS,QAAQ,cAAc,WAAW,EAAE,WAAW;;;;;;;;;;;kCAKnE,8OAAC;wBAAQ,WAAU;kCACf,cAAA,8OAAC,wIAAO;4BACJ,SAAS,gBAAgB,OAAO;4BAChC,QAAQ,gBAAgB,MAAM;4BAC9B,OAAO,gBAAgB,KAAK;4BAC5B,gBAAgB,gBAAgB,cAAc;4BAC9C,eAAe,cAAc,aAAa;4BAC1C,gBAAgB,cAAc,cAAc;4BAC5C,eAAe,cAAc,aAAa;4BAC1C,aAAa,cAAc,WAAW;4BACtC,sBAAsB;4BACtB,eAAe,CAAC;gCACZ,cAAc,gBAAgB,CAAC,CAAA,OAC3B,KAAK,QAAQ,CAAC,SAAS,KAAK,MAAM,CAAC,CAAA,IAAK,MAAM,SAAS;2CAAI;wCAAM;qCAAM;4BAE/E;4BACA,WAAW,CAAC,MAAM,QAAU,IAAI,OAAO,CAAC,KAAK,SAAS,EAAE,MAAM,WAAW;4BACzE,eAAe,IAAI,aAAa;4BAChC,eAAe;4BACf,kBAAkB,IAAM,IAAI,YAAY,CAAC;4BACzC,cAAc,cAAc,kBAAkB;4BAC9C,cAAc,IAAI,YAAY;4BAC9B,cAAc,cAAc,YAAY;4BACxC,eAAe,cAAc,eAAe;4BAC5C,iBAAiB,cAAc,WAAW,EAAE,WAAW,IAAI,CAAA,IAAK,EAAE,KAAK,KAAK,EAAE;4BAC9E,sBAAsB,gBAAgB,OAAO;4BAC7C,sBAAsB,gBAAgB,KAAK;;;;;;;;;;;oBAIlD,IAAI,WAAW,kBACZ,8OAAC;wBAAQ,WAAU;kCACf,cAAA,8OAAC,8IAAU;4BACP,cAAc,cAAc,YAAY;4BACxC,mBAAmB,cAAc,WAAW;4BAC5C,mBAAmB,cAAc,YAAY;4BAC7C,gBAAgB,cAAc,cAAc;4BAC5C,cAAc,cAAc,kBAAkB;4BAC9C,sBAAsB,cAAc,oBAAoB;4BACxD,gBAAgB,cAAc,cAAc;4BAC5C,qBAAqB,cAAc,mBAAmB;4BACtD,WAAW,gBAAgB,MAAM,KAAK;4BACtC,QAAQ,gBAAgB,MAAM;4BAC9B,QAAQ;4BACR,gBAAgB,cAAc,cAAc;4BAC5C,mBAAmB,cAAc,iBAAiB;4BAClD,cAAc,IAAI,YAAY;4BAC9B,2BAA2B;4BAC3B,yBAAyB;;;;;;;;;;;;;;;;;0BAMzC,8OAAC,0JAAgB;gBACb,MAAM,IAAI,aAAa;gBACvB,SAAS,IAAM,IAAI,gBAAgB,CAAC;gBACpC,UAAU,cAAc,WAAW,EAAE,aAAa,EAAE;gBACpD,aAAa,cAAc,WAAW,EAAE;gBACxC,gBAAgB,cAAc,WAAW,EAAE;gBAC3C,sBAAsB,cAAc,WAAW,EAAE;gBACjD,mBAAmB,cAAc,oBAAoB,EAAE;gBACvD,sBAAsB,cAAc,oBAAoB,EAAE;gBAC1D,yBAAyB,cAAc,oBAAoB,EAAE;gBAC7D,YAAY,CAAC;oBACT,MAAM,UAAU,cAAc,WAAW;oBACzC,IAAI,CAAC,SAAS;oBACd,cAAc,cAAc,CAAC;wBAAE,GAAG,OAAO;wBAAE,WAAW;oBAAQ;gBAClE;gBACA,eAAe;oBACX,MAAM,UAAU,cAAc,WAAW;oBACzC,IAAI,CAAC,WAAW,CAAC,QAAQ,oBAAoB,EAAE,QAAQ;oBAEvD,oBAAoB;oBACpB,IAAI;wBACA,MAAM,SAAS,MAAM,IAAA,2KAAkB,EACnC;4BACI,aAAa,QAAQ,WAAW,IAAI,EAAE;4BACtC,gBAAgB,QAAQ,cAAc,IAAI,EAAE;4BAC5C,UAAU,QAAQ,SAAS,CAAC,GAAG,CAAC,CAAA,IAAK,CAAC;oCAClC,OAAO,EAAE,KAAK;oCACd,eAAe,EAAE,aAAa;oCAC9B,UAAU,EAAE,QAAQ;oCACpB,UAAU,EAAE,QAAQ;oCACpB,aAAa,EAAE,WAAW;gCAC9B,CAAC;wBACL,GACA,QAAQ,oBAAoB,EAC5B,cAAc,cAAc;wBAGhC,IAAI,OAAO,CAAC,OAAO,IAAI,CAAC,SAAS,EAAE,OAAO,KAAK,CAAC,WAAW;wBAE3D,MAAM,qBAAqB,QAAQ,SAAS,CAAC,GAAG,CAAC,CAAC,UAAU,MAAQ,CAAC;gCACjE,GAAG,QAAQ;gCACX,OAAO,OAAO,iBAAiB,CAAC,IAAI,EAAE,SAAS,SAAS,KAAK;gCAC7D,eAAe,OAAO,iBAAiB,CAAC,IAAI,EAAE,iBAAiB,SAAS,aAAa;gCACrF,UAAU,OAAO,iBAAiB,CAAC,IAAI,EAAE,YAAY,SAAS,QAAQ;gCACtE,UAAU,OAAO,iBAAiB,CAAC,IAAI,EAAE,YAAY,SAAS,QAAQ;gCACtE,aAAa,OAAO,iBAAiB,CAAC,IAAI,EAAE,eAAe,SAAS,WAAW;4BACnF,CAAC;wBAED,cAAc,uBAAuB,CAAC;4BAClC,GAAG,OAAO;4BACV,WAAW;4BACX,aAAa,OAAO,oBAAoB;4BACxC,gBAAgB,OAAO,uBAAuB;wBAClD;oBACJ,EAAE,OAAO,OAAO;wBACZ,QAAQ,KAAK,CAAC,qCAAqC;oBACvD,SAAU;wBACN,oBAAoB;oBACxB;gBACJ;gBACA,cAAc;gBACd,gBAAgB,CAAC;oBACb,MAAM,UAAU,cAAc,WAAW;oBACzC,IAAI,SAAS,cAAc,cAAc,CAAC;wBAAE,GAAG,OAAO;wBAAE,WAAW;oBAAS;oBAC5E,IAAI,gBAAgB,CAAC;oBACrB;gBACJ;gBACA,oBAAoB,CAAC;oBACjB,MAAM,UAAU,cAAc,WAAW;oBACzC,IAAI,CAAC,SAAS;oBACd,cAAc,cAAc,CAAC;wBACzB,GAAG,OAAO;wBACV,sBAAsB,YACjB,MAAM,CAAC,CAAA,IAAK,EAAE,MAAM,KAAK,QACzB,GAAG,CAAC,CAAA,IAAK,CAAC;gCACP,UAAU,EAAE,QAAQ;gCACpB,aAAa,EAAE,MAAM,KAAK,WAAW,KAAM,EAAE,iBAAiB,IAAI,EAAE,WAAW;gCAC/E,QAAQ,EAAE,MAAM;4BACpB,CAAC;oBACT;gBACJ;;;;;;;;;;;;AAIhB"}}]
}